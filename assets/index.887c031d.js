var rt=Object.defineProperty,at=Object.defineProperties;var lt=Object.getOwnPropertyDescriptors;var Z=Object.getOwnPropertySymbols;var ct=Object.prototype.hasOwnProperty,ut=Object.prototype.propertyIsEnumerable;var B=(a,t,e)=>t in a?rt(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e,v=(a,t)=>{for(var e in t||(t={}))ct.call(t,e)&&B(a,e,t[e]);if(Z)for(var e of Z(t))ut.call(t,e)&&B(a,e,t[e]);return a},N=(a,t)=>at(a,lt(t));var r=(a,t,e)=>(B(a,typeof t!="symbol"?t+"":t,e),e);import{e as ht,_ as q,R as L,j as u,r as P,a as x,C as dt,F as Q,h as R,b as gt,P as ft,c as mt}from"./vendor.baa2301a.js";const pt=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function e(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerpolicy&&(i.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?i.credentials="include":n.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(n){if(n.ep)return;n.ep=!0;const i=e(n);fetch(n.href,i)}};pt();function F(a,t){const e=Math.pow(t[0]-a[0],2)+Math.pow(t[1]-a[1],2);return Math.pow(e,1/2)}function At(a,t,e){const o=Math.atan2(a[1]-t[1],a[0]-t[0]);return e!=="DEGREES"?o:180/Math.PI*o}function Pt(a,t,e){return new Promise(o=>{a.toBlob(n=>{o(n)},t,e)})}const _="EMITTER_PLUGIN_ACTIVED",z="EMITTER_ANNOTATION_INFO_UPDATED",H="EMITTER_ANNOTATION_INFO_UPDATED";var X=new ht.exports.EventEmitter;class Y{constructor(t,e,o){r(this,"annotations",[]);r(this,"name");r(this,"editingAnnotation");r(this,"options");r(this,"pluginsCount",0);r(this,"pluginItemWH",20);r(this,"pluginItemMargin",5);r(this,"state");r(this,"scale",1);r(this,"translateX",0);r(this,"translateY",0);r(this,"loadedImage");r(this,"customConfigAnnotation");r(this,"getToolInfo",()=>Promise.resolve({time:new Date().getTime()}));r(this,"transformValue",t=>t*this.scale);r(this,"transformPoint",t=>[this.transformValue(t[0])+this.translateX,this.transformValue(t[1])+this.translateY]);r(this,"restorePoint",t=>[(t[0]-this.translateX)/this.scale,(t[1]-this.translateY)/this.scale]);this.name=t,e&&(this.annotations=e),this.state=o||{}}configAnnotation(t,e){var n;const o=e.options;if(o==null?void 0:o.strokeColor){const i=t.color(o.strokeColor),s=t.map(o.strokeAlpha||1,0,1,0,255);i.setAlpha(s),t.stroke(i)}else t.noStroke();(o==null?void 0:o.fillColor)?t.fill(o.fillColor):t.noFill(),(o==null?void 0:o.textSize)&&t.textSize(o.textSize*this.scale),(o==null?void 0:o.strokeWeight)&&t.strokeWeight(o.strokeWeight*this.scale),(o==null?void 0:o.textStyle)&&t.textStyle(o.textStyle),(n=this.customConfigAnnotation)==null||n.call(this,this,e)}getInitialOptions(){return{textSize:12,strokeColor:"#111",strokeWeight:1}}getInitialAnnotation(){const t=this;return{info:{time:new Date().getTime()},remove:function(){t.annotations.splice(t.annotations.indexOf(this),1)},belong:this.name,options:v(v({},this.getInitialOptions()),this.options),translateX:0,translateY:0,scale:1,transformedStartPoint:function(){if(!!this.startPoint)return[t.transformValue(this.startPoint[0]+this.translateX)+t.translateX,t.transformValue(this.startPoint[1]+this.translateY)+t.translateY]},transformedEndPoint:function(){if(!!this.endPoint)return[t.transformValue(this.endPoint[0]+this.translateX)+t.translateX,t.transformValue(this.endPoint[1]+this.translateY)+t.translateY]}}}validateAnnotation(t){return!(F(t.startPoint,t.endPoint)<2)}preload(t){}setup(t){}mouseMoved(t){}draw(t){}touchStarted(t){this.editingAnnotation=N(v({},this.getInitialAnnotation()),{startPoint:this.restorePoint([t.mouseX,t.mouseY])}),this.annotations.push(this.editingAnnotation)}touchMoved(t){this.editingAnnotation?this.editingAnnotation.endPoint=this.restorePoint([t.mouseX,t.mouseY]):this.touchStarted(t)}touchEnded(t){var e;!this.editingAnnotation||(this.editingAnnotation.endPoint=this.restorePoint([t.mouseX,t.mouseY]),this.validateAnnotation(this.editingAnnotation)?this.getToolInfo(this).then(o=>{this.editingAnnotation&&(this.editingAnnotation.info=o,X.emit(z))}).catch(o=>{console.warn(o)}).finally(()=>{this.editingAnnotation=void 0}):((e=this.annotations)==null||e.pop(),this.editingAnnotation=void 0))}reverseStartEndPointByOrder(){if(this.editingAnnotation&&this.editingAnnotation.startPoint&&this.editingAnnotation.endPoint){const[t,e]=this.editingAnnotation.startPoint,[o,n]=this.editingAnnotation.endPoint;this.editingAnnotation.startPoint=[Math.min(t,o),Math.min(e,n)],this.editingAnnotation.endPoint=[Math.max(t,o),Math.max(e,n)]}}pointInAnnotation(t,e){return!1}getPluginOrigin(t){return t.startPoint||[0,0]}pointInPluginLayer(t,e){const o=this.getPluginOrigin(e);return t[0]>o[0]&&t[0]<o[0]+(this.pluginItemWH+this.pluginItemMargin)*this.pluginsCount&&t[1]>o[1]&&t[1]<o[1]+this.pluginItemWH}}r(Y,"toolName");class j extends Y{constructor(t){super("CircleTool",t)}getPluginOrigin(t){const e=t.transformedStartPoint(),o=t.transformedEndPoint();if(e&&o){const n=F(e,o);return[e[0]+n+(t.options.strokeWeight||1)*this.scale/2,e[1]-this.pluginItemWH/2]}return[0,0]}pointInAnnotation(t,e){const o=e.transformedStartPoint(),n=e.transformedEndPoint();if(!o||!n)return!1;const i=F(o,n);return F(o,t)<i?!0:this.pointInPluginLayer(t,e)}touchEnded(t){if(super.touchEnded(t),this.editingAnnotation){const[e,o]=this.editingAnnotation.startPoint,n=F(this.editingAnnotation.startPoint,this.editingAnnotation.endPoint);this.editingAnnotation.endPoint=[e+n,o]}}draw(t){for(const e of this.annotations||[]){const o=e.transformedStartPoint(),n=e.transformedEndPoint();if(!o||!n)return;super.configAnnotation(t,e),t.circle(o[0],o[1],F(o,n)*2)}}}r(j,"toolName","CircleTool");class J extends Y{constructor(t){super("SquareTool",t)}getPluginOrigin(t){const e=t.transformedStartPoint(),o=t.transformedEndPoint();if(!o||!e)return[0,0];const n=[e[0],o[0]],i=[e[1],o[1]];return[Math.max(...n)+(t.options.strokeWeight||1)*this.scale,Math.max(...i)-this.pluginItemWH+(t.options.strokeWeight||1)*this.scale/2]}touchEnded(t){super.touchEnded(t),this.reverseStartEndPointByOrder()}pointInAnnotation(t,e){const o=e.transformedStartPoint(),n=e.transformedEndPoint();if(!n||!o)return!1;const i=[o[0],n[0]],s=[o[1],n[1]];return t[0]<Math.max(...i)&&t[0]>Math.min(...i)&&t[1]<Math.max(...s)&&t[1]>Math.min(...s)?!0:this.pointInPluginLayer(t,e)}draw(t){for(const e of this.annotations||[]){const o=e.transformedStartPoint(),n=e.transformedEndPoint();if(!o||!n)return;super.configAnnotation(t,e),t.quad(o[0],o[1],n[0],o[1],n[0],n[1],o[0],n[1])}}}r(J,"toolName","SquareTool");class K extends Y{constructor(t){super("LineTool",t);r(this,"showDistance",!1)}draw(t){var e,o;for(const n of this.annotations||[]){const i=n.transformedStartPoint(),s=n.transformedEndPoint();if(!i||!s)return;super.configAnnotation(t,n),t.line(i[0],i[1],s[0],s[1]),t.textSize(n.options.textSize*this.scale),t.fill(n.options.strokeColor),this.showDistance&&t.text(F(i,s).toFixed(1),(s[0]-i[0])/2+(((e=this.options)==null?void 0:e.strokeWeight)||5)+i[0],(s[1]-i[1])/2+(((o=this.options)==null?void 0:o.strokeWeight)||5)+i[1]+n.options.textSize)}}}r(K,"toolName","LineTool");class $ extends Y{constructor(t){super("ArrowLineTool",t);this.getToolInfo=()=>{const e=prompt("\u8BF7\u8F93\u5165")||"";return Promise.resolve({title:e,time:new Date().getTime()})}}draw(t){var e;for(const o of this.annotations||[]){const n=o.transformedStartPoint(),i=o.transformedEndPoint();if(!n||!i)return;t.angleMode("degrees");const s=At(n,i,"DEGREES"),c=(((e=o.options)==null?void 0:e.strokeWeight)||1)*8,f=[n[0]+c*t.cos(s-145)*this.scale,n[1]+c*t.sin(s-145)*this.scale],g=[n[0]+c*t.cos(s+145)*this.scale,n[1]+c*t.sin(s+145)*this.scale];super.configAnnotation(t,o),t.line(n[0],n[1],i[0],i[1]),t.line(n[0],n[1],f[0],f[1]),t.line(n[0],n[1],g[0],g[1]),t.noStroke(),t.textSize(o.options.textSize*this.scale),t.fill(o.options.strokeColor),t.text(o.info.title||"",n[0]+5*t.cos(s)/4,n[1]+5*t.sin(s)/4+.8*(s>0?t.textAscent():-t.textAscent()*.5))}}}r($,"toolName","ArrowLineTool");class k extends Y{constructor(t){super("FreehandTool",t)}getInitialAnnotation(){return N(v({},super.getInitialAnnotation()),{belong:"FreehandTool",freePaths:[]})}touchMoved(t){var n,i,s;const e=((n=this.editingAnnotation)==null?void 0:n.freePaths[this.editingAnnotation.freePaths.length-1])||((i=this.editingAnnotation)==null?void 0:i.startPoint),o=this.restorePoint([t.mouseX,t.mouseY]);e&&o&&F(e,o)>4&&((s=this.editingAnnotation)==null||s.freePaths.push(o))}draw(t){for(const e of this.annotations||[]){const o=e.startPoint,n=e.endPoint,i=[o,...e.freePaths,n];super.configAnnotation(t,e);for(let s=0;s<i.length-1;s++){const c=i[s],f=i[s+1];if(!f)break;const g=this.transformPoint(c),p=this.transformPoint(f);t.line(g[0],g[1],p[0],p[1])}}}}r(k,"toolName","FreehandTool");class tt extends Y{constructor(t){super("TextTool",t);this.getToolInfo=()=>{const e=prompt("\u8BF7\u8F93\u5165")||"";return Promise.resolve({title:e,time:new Date().getTime()})}}validateAnnotation(t){return!0}touchEnded(t){super.touchEnded(t),this.editingAnnotation&&(this.editingAnnotation.startPoint=this.restorePoint([t.mouseX,t.mouseY]))}getPluginOrigin(t){const e=t.transformedStartPoint();return e?[e[0]-t.textWidth/2,e[1]-this.pluginItemWH-t.textHeight]:[0,0]}pointInAnnotation(t,e){const o=e.transformedStartPoint();if(!o)return!1;const n=e.textWidth/2;return t[0]>o[0]-n&&t[0]<o[0]+n&&t[1]>o[1]-e.textHeight&&t[1]<o[1]?!0:this.pointInPluginLayer(t,e)}draw(t){for(const e of this.annotations||[]){const o=e.transformedStartPoint();if(!o)return;super.configAnnotation(t,e),t.noStroke();const n=e.info.title||"",i=t.textWidth(n);e.textWidth=i;const s=t.textAscent();e.textHeight=s,t.text(n,o[0]-i/2,o[1])}}}r(tt,"toolName","TextTool");const xt={top:"ns-resize","top-right":"nesw-resize","top-left":"nwse-resize",left:"ew-resize",right:"ew-resize","in-rect":"MOVE","out-rect":"default",bottom:"ns-resize","bottom-left":"nesw-resize","bottom-right":"nwse-resize"},A=6,G=(a,t,e)=>{let o="out-rect";if(!t||!e)return"out-rect";const[n,i]=a,s=Math.min(t[0],e[0]),c=Math.max(t[0],e[0]),f=Math.min(t[1],e[1]),g=Math.max(t[1],e[1]),p=n>s-A&&n<s+A,m=i>f-A&&i<f+A,C=n>c-A&&n<c+A,S=i>g-A&&i<g+A;return n>s+A&&n<c-A&&i>f+A&&i<g-A?o="in-rect":m?(o="top",p?o="top-left":C&&(o="top-right")):S?(o="bottom",p?o="bottom-left":C&&(o="bottom-right")):p?o="left":C?o="right":o="out-rect",o};class ot extends Y{constructor(t,e){super("CropTool",t);r(this,"cursorPosition","out-rect");r(this,"touchStartPoint",[0,0]);r(this,"images",[]);r(this,"pg");r(this,"startRect");r(this,"endRect");this.state.cropedImages=e||[]}endCrop(){var t;(t=this.editingAnnotation)==null||delete t.startPoint,this.annotations=[]}async pureCrop(t,e,o,n){const[i,s]=e,[c,f]=o,g=t.get();t.noLoop(),t.clear(),t.image(g,0,0,t.width,t.height);const p=t.get(i+A/2,s+A/2,c-i-A,f-s-A).canvas,m=await Pt(p,n);return t.loop(),m}async doCrop(t,e,o){const n=this.annotations[0];await(e==null?void 0:e(t));const i=await this.pureCrop(t,n.transformedStartPoint(),n.transformedEndPoint());if(await(o==null?void 0:o(t)),i){const s=URL.createObjectURL(i),c=await this.getToolInfo(this);this==null||this.images.push({info:c,url:s}),X.emit(H)}this.endCrop()}touchStarted(t){var i,s,c;const e=(i=this.editingAnnotation)==null?void 0:i.startPoint,o=(s=this.editingAnnotation)==null?void 0:s.endPoint,n=this.restorePoint([t.mouseX,t.mouseY]);this.cursorPosition=G(n,e,o),this.cursorPosition==="out-rect"&&(this.editingAnnotation=N(v({},this.getInitialAnnotation()),{belong:"CropTool",startPoint:n}),this.annotations=[this.editingAnnotation],(c=this.startRect)==null||c.call(this,{startX:n[0],startY:n[1]})),this.touchStartPoint=[t.mouseX,t.mouseY]}touchMoved(t){const e=this.editingAnnotation,o=this.restorePoint([t.mouseX,t.mouseY]);this.cursorPosition==="out-rect"&&(e.endPoint=o);const n=e.startPoint,i=e.endPoint;let s=n[0],c=n[1],f=i[0],g=i[1];const p=(t.mouseX-this.touchStartPoint[0])/this.scale,m=(t.mouseY-this.touchStartPoint[1])/this.scale;switch(this.cursorPosition){case"in-rect":s+=p,c+=m,f+=p,g+=m;break;case"top":c+=m;break;case"bottom":g+=m;break;case"left":s+=p;break;case"right":f+=p;break;case"top-left":s+=p,c+=m;break;case"top-right":f+=p,c+=m;break;case"bottom-left":s+=p,g+=m;break;case"bottom-right":f+=p,g+=m;break}e.startPoint=[s,c],e.endPoint=[f,g],this.touchStartPoint=[t.mouseX,t.mouseY],this.doEndRect()}doEndRect(){var o,n;if(!((o=this.editingAnnotation)==null?void 0:o.startPoint)||!this.editingAnnotation.endPoint)return;const t=this.editingAnnotation.transformedStartPoint(),e=this.editingAnnotation.transformedEndPoint();(n=this.endRect)==null||n.call(this,{startX:Math.min(t[0],e[0]),startY:Math.min(t[1],e[1]),endX:Math.max(t[0],e[0]),endY:Math.max(t[1],e[1])})}touchEnded(t){this.editingAnnotation&&this.reverseStartEndPointByOrder()}drawCropArea(t,e,o,n){if(!this.pg)return;const i=this.editingAnnotation;this.pg.erase(),this.pg.quad(t+i.translateX+1,e+i.translateY+1,o+i.translateX-1,e+i.translateY+1,o+i.translateX-1,n+i.translateY-1,t+i.translateX+1,n+i.translateY-1),this.pg.noErase()}draw(t){var m,C,S,M,D;if(this.pg||(this.pg=t.createGraphics(t.width,t.height)),t.width!==this.pg.width||t.height!==this.pg.height?(this.pg.resizeCanvas(t.width,t.height),this.doEndRect()):(m=this.pg)==null||m.clear(),this.pg.background(0,0,0,120),!this.editingAnnotation)return;const e=this.editingAnnotation,o=e.transformedStartPoint(),n=e.transformedEndPoint();if(!o||!n)return;const i=Math.min(o[0],n[0]),s=Math.min(o[1],n[1]),c=Math.max(o[0],n[0]),f=Math.max(o[1],n[1]),g=G(this.restorePoint([t.mouseX,t.mouseY]),e.startPoint,e.endPoint);g==="out-rect"?t.cursor(t.CROSS):t.cursor(xt[g]),this.pg.stroke(e.options.strokeColor),(C=this.pg)==null||C.stroke(e.options.strokeColor),(S=this.pg)==null||S.strokeWeight(1),this.pg.fill(255,255,255,255),(M=this.pg)==null||M.quad(i,s,c,s,c,f,i,f),this.drawCropArea(i,s,c,f);const p=[[i,s],[i,f],[c,s],[c,f]];(D=this.pg)==null||D.fill(e.options.strokeColor),p.forEach(([I,l])=>{var T;(T=this.pg)==null||T.quad(I-A/2,l-A/2,I+A/2,l-A/2,I+A/2,l+A/2,I-A/2,l+A/2)}),t.image(this.pg,0,0,t.width,t.height)}}r(ot,"toolName","CropTool");class et extends Y{constructor(){super("MagnifyTool");r(this,"areaWidth",50);r(this,"zoomScale",2)}draw(t){if(this.editingAnnotation&&this.loadedImage){const e=this.editingAnnotation.endPoint||this.editingAnnotation.startPoint,o=this.editingAnnotation.transformedEndPoint()||this.editingAnnotation.transformedStartPoint(),n=this.areaWidth/2,i=this.scale*this.zoomScale,s=this.areaWidth*i/2,c=this.loadedImage.get(e[0]-n,e[1]-n,this.areaWidth,this.areaWidth);t.image(c,o[0]-s,o[1]-s,this.areaWidth*i,this.areaWidth*i)}}}r(et,"toolName","MagnifyTool");class U{constructor(t){r(this,"name","");r(this,"tools",[]);r(this,"enabled",!1);r(this,"active",!1);r(this,"iconUrl");r(this,"icon");r(this,"totalPluginsCount",0);r(this,"pluginIndex",0);r(this,"pluginItemWH",20);r(this,"pluginItemMargin",5);r(this,"touchStartPoint");r(this,"touchEndPoint",[0,0]);r(this,"editingAnnotation");r(this,"pluginLayerOrigin");r(this,"scale",1);r(this,"translateX",0);r(this,"translateY",0);this.iconUrl=t,X.on(_,e=>{e!==this.name&&(this.active=!1)})}preload(t){this.iconUrl&&t.loadImage(this.iconUrl,e=>{this.icon=e})}draw(t){if(!!this.enabled){for(const e of this.tools)for(const o of e.annotations)if(e.pointInAnnotation([t.mouseX,t.mouseY],o)){if(!o.startPoint)continue;this.pluginLayerOrigin=e.getPluginOrigin(o);const n=this.pluginLayerOrigin[0]+(this.pluginItemWH+this.pluginItemMargin)*this.pluginIndex;t.noStroke(),t.fill("#ffffff"),t.rect(n,this.pluginLayerOrigin[1],this.pluginItemWH,this.pluginItemWH),t.image(this.icon,n,this.pluginLayerOrigin[1],this.pluginItemWH,this.pluginItemWH)}}}touchStarted(t){for(const e of this.tools)for(const o of e.annotations){const n=e.getPluginOrigin(o),i=n[0]+(this.pluginItemWH+this.pluginItemMargin)*this.pluginIndex,s=n[1];if(t.mouseX>i&&t.mouseX<i+this.pluginItemWH&&t.mouseY>s&&t.mouseY<s+this.pluginItemWH){this.active=!0,this.editingAnnotation=o,e.getPluginOrigin(o),this.touchStartPoint=[t.mouseX,t.mouseY],X.emit(_,this.name);return}}}touchMoved(t){this.touchEndPoint=[t.mouseX,t.mouseY],this.handleTouchMoved(t)}touchEnded(t){this.active=!1}handleTouchMoved(t){}}r(U,"pluginName");const Tt="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAARVJREFUSEvFlsENwjAMRX/lbegE3JiiEzCApQ4ADFDJM3DsFJy4cYRhkCxQqga1IU0MKCKnHhw/2/8naQXjatt2papHAHci2nZdd7NsrSxBY/IeQD3GX4mosUCygEhyX5MJkgQEya/TDsbvLCQJYOY9gB2AIZGqOgiIqFZVP7KDiLi46MoBNgA2RNS7eTPzw2URkWrsrgFwEpHTV4Bw0xRgMYeLmXWQqyoFYOZZt76AFyAQNDrXDGCml7fwAAjdsuTxFGAphxfLOyJpu5wGMUjFzGcAa6toH8ZdygOs83eVfzWi4iL7mRa1aQBZPP4/HTSLO3IaxHL897Irfl0Xf3AiFp6OOfuavV3XS0IXffQDC3/82/IEL+oxZnXZjqwAAAAASUVORK5CYII=";class Ct extends U{constructor(){super(Tt);this.name="MovePlugin"}handleTouchMoved(t){!this.editingAnnotation||(this.editingAnnotation.translateX=(this.touchEndPoint[0]-this.touchStartPoint[0])/this.scale+this.editingAnnotation.translateX,this.editingAnnotation.translateY=(this.touchEndPoint[1]-this.touchStartPoint[1])/this.scale+this.editingAnnotation.translateY,this.touchStartPoint=[t.mouseX,t.mouseY])}}const Et="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAATtJREFUSEvllT1OxDAQhZ/jG3AMKLeiS0cD7VacIRklB2BzgESTgoaeZltoqNhuT7AcgQaJGzhBjmJkjEHZSahwl8gz3/y9scIfH+X8Z1m2SpLkKsbr+37ftu2TJJYBQEQpgOffHDDzZzDHgBxgA+AmMKzc9xIZhIA3rXVa1/XLMdHG7sYyeAdwAuCgtV7PhYSASmu9NcZsAZwtAfkGYOZNWZanS0GiAFvLAFJZsKQfA6Aoisuu6x6sDpqmeXSORsgawI6Zd2KAxHCqjUg8U53be/8YMO6v1OrGF+M4GAc3MOISEZFbL18UT0R2adrlOYy2GPCTGBcDRMQ4ZGKMuV0kg0CMbnf5EzyvRL4n19jwPZnVg3GK/EfKNtY/18x8L24yEfVTnlgxIM/zC6XUeQTyysx37r8YMHUffQC+w6kZYxwPvQAAAABJRU5ErkJggg==";class St extends U{constructor(){super(Et);this.name="ScalePlugin"}handleTouchMoved(t){if(!this.editingAnnotation)return;const[e,o]=this.editingAnnotation.endPoint,[n,i]=this.editingAnnotation.startPoint,s=e+(this.touchEndPoint[0]-this.touchStartPoint[0])/this.scale;let c=o+(this.touchEndPoint[1]-this.touchStartPoint[1])/this.scale;this.editingAnnotation.belong==="CircleTool"&&(c=i),this.editingAnnotation.startPoint=[Math.min(n,s),Math.min(i,c)],this.editingAnnotation.endPoint=[Math.max(n,s),Math.max(i,c)],this.touchStartPoint=[t.mouseX,t.mouseY]}}class h{constructor(){r(this,"tools",[]);r(this,"plugins",[]);r(this,"_toolsMapping",{});r(this,"touchStatus","end");r(this,"hasEnabledToolCallback");r(this,"_enabledTool");this.tools=[],this._toolsMapping={}}set enabledTool(t){var e;this._enabledTool=t,(e=this.hasEnabledToolCallback)==null||e.call(this,!!t);for(const o of this.plugins)o.enabled=!t}get enabledTool(){return this._enabledTool}useTool(t,e){return this.findTool(t.name)?(console.error("tool: %s\u5DF2\u5B58\u5728, \u8BF7\u52FF\u91CD\u590D\u6DFB\u52A0"),this):(this._toolsMapping[t.name]=t,t.getToolInfo=e||t.getToolInfo,this.tools.push(t),this)}removeTool(t){if(t&&this._toolsMapping[t.name]){delete this._toolsMapping[t.name];const e=q.indexOf(this.tools,t);this.tools.splice(e,1)}return this}usePlugin(t,e){let o=!1;for(const n of this.plugins)if(t.name===n.name){o=!0;break}o?console.error("%s\u5DF2\u5B58\u5728, \u8BF7\u52FF\u91CD\u590D\u6DFB\u52A0",t.name):(t.tools=e,this.plugins.push(t));for(let n=0;n<this.plugins.length;n++){const i=this.plugins[n];i.totalPluginsCount=this.plugins.length,i.pluginIndex=n}for(const n of this.tools)n.pluginsCount=this.plugins.length;return this}setup(t){for(const e of this.tools)e.setup(t)}preload(t){for(const e of this.tools)e.preload(t);for(const e of this.plugins)e.preload(t)}draw(t,e,o,n){for(const i of this.tools)i.scale=e||1,i.translateX=o||0,i.translateY=n||0,i.draw(t);for(const i of this.plugins)i.scale=e||1,i.translateX=o||0,i.translateY=n||0,i.draw(t)}mouseMoved(t){}touchStarted(t){var e;this.touchStatus="start",(e=this.enabledTool)==null||e.touchStarted(t);for(const o of this.plugins)o.touchStarted(t)}touchMoved(t){var e;this.touchStatus="moving",(e=this.enabledTool)==null||e.touchMoved(t);for(const o of this.plugins)o.active&&o.touchMoved(t)}touchEnded(t){var e;this.touchStatus="end",(e=this.enabledTool)==null||e.touchEnded(t);for(const o of this.plugins)o.active&&o.touchEnded(t)}findTool(t){return this._toolsMapping[t]}setToolEnabled(t,e){const o=this.findTool(t);o?(o.options=e,this.enabledTool=o):console.error("\u672A\u8BBE\u7F6Etool\uFF1A%s",t)}quitTool(){this.enabledTool=void 0}getAllAnnotations(){let t=[];for(const e of this.tools)for(const o of e.annotations)t.push(o);return t}}r(h,"CircleTool",j),r(h,"SquareTool",J),r(h,"LineTool",K),r(h,"FreehandTool",k),r(h,"TextTool",tt),r(h,"ArrowLineTool",$),r(h,"CropTool",ot),r(h,"MagnifyTool",et),r(h,"MovePlugin",Ct),r(h,"ScalePlugin",St);const wt=a=>{const[t,e]=P.exports.useState("2"),[o,n]=P.exports.useState("1"),[i,s]=P.exports.useState("#f44336");return x("div",{className:"options",style:{top:a.rect.top,left:a.rect.left-290},children:[u("p",{children:"\u753B\u7B14\u7C97\u7EC6\uFF1A"}),u("input",{value:t,onChange:c=>e(c.target.value)}),u("p",{children:"\u900F\u660E\u5EA6\uFF1A"}),u("input",{value:o,onChange:c=>n(c.target.value)}),u("div",{children:u(dt,{color:i,onChange:c=>s(c.hex)})}),x("div",{className:"flex items-center mt-20px",children:[u("button",{className:"flex-1 mr-10px",onClick:()=>{a.onConfirm({width:parseFloat(t)||2,alpha:parseFloat(o)||1,color:i})},children:"\u786E\u8BA4"}),u("button",{className:"flex-1",onClick:a.onCancel,children:"\u53D6\u6D88"})]})]})},vt=a=>{const t=a.target.getBoundingClientRect();return new Promise((e,o)=>{let n=document.createElement("div");n.style.position="fixed",n.style.left="0",n.style.right="0",n.style.bottom="0",n.style.top="0",document.body.appendChild(n);const i=()=>{L.unmountComponentAtNode(n),document.body.removeChild(n),n=null};L.render(u(wt,{rect:t,onCancel:()=>{i(),o()},onConfirm:s=>{i(),e(s)}}),n)})};const It=a=>{const[t,e]=P.exports.useState(a.info);return x("div",{className:"w-250px bg-white flex flex-col p-20px children:my-5px",children:[u("p",{children:"\u6807\u9898: "}),u("input",{value:(t==null?void 0:t.title)||"",onChange:o=>e(N(v({},t),{title:o.target.value}))}),u("p",{children:"\u5907\u6CE8: "}),u("input",{value:(t==null?void 0:t.remark)||"",onChange:o=>e(N(v({},t),{remark:o.target.value}))}),u("p",{children:"\u5176\u4ED6\u4FE1\u606F: "}),u("input",{value:(t==null?void 0:t.others)||"",onChange:o=>e(N(v({},t),{others:o.target.value}))}),x("div",{className:"flex items-center mt-20px",children:[u("button",{className:"flex-1 mr-10px",onClick:()=>{a.onConfirm(N(v({},t),{time:new Date().getTime()}))},children:"\u786E\u8BA4"}),u("button",{className:"flex-1",onClick:a.onCancel,children:"\u53D6\u6D88"})]})]})},nt=a=>new Promise(t=>{let e=document.createElement("div");e.style.position="fixed",e.style.left="0",e.style.right="0",e.style.bottom="0",e.style.top="0",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",document.body.appendChild(e);const o=()=>{L.unmountComponentAtNode(e),document.body.removeChild(e),e=null};L.render(u(It,{info:a,onCancel:()=>{o(),t(!1)},onConfirm:n=>{o(),t(n)}}),e)}),yt=a=>{const[t,e]=P.exports.useState(!0),[o,n]=P.exports.useState([]),[i,s]=P.exports.useState(!1),[c,f]=P.exports.useState([]),g=(l,T)=>{const b=R(l.info.time),w=R(T.info.time);return b.isAfter(w)?-1:1},p=()=>{const l=a.manager.getAllAnnotations().sort(g);n(l)},m=()=>{const T=a.manager.findTool(h.CropTool.toolName).images.sort(g);f([...T])};P.exports.useEffect(()=>(X.on(z,p),X.on(H,m),()=>{X.removeListener(z,p),X.removeListener(H,m)}),[]);const C=async(l,T)=>{var b;try{const w=await vt(l);(b=a.sk)==null||b.cursor(a.sk.ARROW),T===h.TextTool.toolName?a.manager.setToolEnabled(T,{fillColor:w.color,strokeAlpha:w.alpha,textSize:w.width}):a.manager.setToolEnabled(T,{strokeColor:w.color,strokeAlpha:w.alpha,strokeWeight:w.width})}catch{a.manager.quitTool()}},S=()=>{var l;(l=a.sk)==null||l.cursor(a.sk.CROSS),a.manager.setToolEnabled(h.CropTool.toolName,{strokeColor:"blue"})},M=async l=>{const T=await nt(l.info);T&&(l.info=T,p())},D=l=>{l.remove(),p()},I=l=>{const T=a.manager.findTool(h.CropTool.toolName),b=T.images.indexOf(l);T.images.splice(b,1),m()};return x(Q,{children:[x("div",{className:"common-pannel pannel",children:[u("p",{onClick:l=>C(l,h.CircleTool.toolName),children:"\u5706\u5F62"}),u("p",{onClick:l=>C(l,h.SquareTool.toolName),children:"\u65B9\u5F62"}),u("p",{onClick:l=>C(l,h.TextTool.toolName),children:"\u6587\u5B57"}),u("p",{onClick:l=>C(l,h.LineTool.toolName),children:"\u76F4\u7EBF"}),u("p",{onClick:l=>C(l,h.ArrowLineTool.toolName),children:"\u7BAD\u5934"}),u("p",{onClick:l=>C(l,h.FreehandTool.toolName),children:"freehand"}),u("p",{onClick:l=>S(),children:"\u88C1\u526A"}),u("p",{onClick:l=>{t||s(!1),e(!t)},children:t?"\u9690\u85CF\u6807\u6CE8":"\u663E\u793A\u6807\u6CE8"}),u("p",{onClick:l=>{i||e(!1),s(!i)},children:i?"\u9690\u85CF\u622A\u56FE":"\u663E\u793A\u622A\u56FE"}),u("p",{onClick:l=>a.onChangeDragging(),children:a.dragging?"\u53D6\u6D88\u62D6\u52A8":"\u62D6\u52A8"})]}),t&&x("div",{className:"common-pannel annotations-layer",children:[u("div",{className:"title outer sticky top-0 bg-white",children:"\u6807\u6CE8\u4FE1\u606F"}),o.map(l=>l.belong===h.CropTool.toolName?null:x("div",{className:"items-center outer",children:[u("span",{className:"text-15px font-500",children:l.belong}),x("div",{className:"flex flex-col space-y-5px !py-5px flex-1 !mx-15px w-0",children:[x("span",{children:["\u6807\u9898: ",l.info.title]}),x("span",{children:["\u5907\u6CE8: ",l.info.remark]}),x("span",{children:["\u5176\u4ED6\u4FE1\u606F: ",l.info.others]}),x("span",{children:["\u65F6\u95F4: ",R(l.info.time).format("DD HH:mm:ss")]})]}),x("div",{className:"flex flex-col space-y-10px children:h-25px",children:[u("button",{onClick:()=>M(l),children:"\u7F16\u8F91"}),u("button",{onClick:()=>D(l),children:"\u5220\u9664"})]})]},`annotation-${l.info.time}`))]}),i&&x("div",{className:"common-pannel images-layer",children:[u("div",{className:"title outer sticky top-0 bg-white",children:"\u622A\u56FE"}),c.map((l,T)=>x("div",{className:"flex flex-col space-y-5px outer",children:[x("span",{className:"font-500 text-15px",children:["\u6807\u9898: ",l.info.title]}),x("span",{children:["\u65F6\u95F4: ",R(l.info.time).format("YYYY-MM-DD HH:mm")]}),x("div",{className:"flex items-center !mx-0 !py-0",children:[u("img",{className:"flex-1 w-0 mr-10px",src:l.url}),u("button",{onClick:()=>I(l),children:"\u5220\u9664"})]})]},`image-${l.info.time}`))]})]})};function Mt(){const a=P.exports.useRef(null),[t,e]=P.exports.useState(),[o,n]=P.exports.useState(),[i,s]=P.exports.useState(),[c,f]=P.exports.useState(1),[g,p]=P.exports.useState(!1),[m,C]=P.exports.useState({x:0,y:0}),[S,M]=P.exports.useState(),D=new h.TextTool,I=new h.CircleTool,l=new h.SquareTool,T=new h.LineTool,b=new h.FreehandTool,w=new h.ArrowLineTool,W=new h.CropTool;W.startRect=d=>{M(void 0)},W.endRect=d=>{M([d.startX,d.startY])};const O=async d=>{const y=await nt();return y||q.last(d.annotations).remove(),N(v({},y),{time:new Date().getTime()})},[E]=P.exports.useState(()=>{const d=new h;return d.useTool(D,O).useTool(I,O).useTool(l,O).useTool(T,O).useTool(b,O).useTool(w,O).useTool(W,O),d.usePlugin(new h.MovePlugin,[I,l,D]).usePlugin(new h.ScalePlugin,[l,I]),d});P.exports.useEffect(()=>{if(o){const d=o.createDiv();d.addClass("w-130px h-50px"),gt.exports.render(x(Q,{children:[u("button",{className:"mr-10px w-50px h-30px",onClick:y=>{st(y)},children:"\u786E\u8BA4"}),u("button",{className:"w-50px h-30px",onClick:it,children:"\u53D6\u6D88"})]}),d.elt),s(d)}},[o]),P.exports.useEffect(()=>{!i||(S?(i.position(S[0],S[1]-35),i.show()):i.hide())},[S,i]);const V=P.exports.useCallback(()=>{!o||!t||(o.clear(),o.resizeCanvas(t.width*c,t.height*c,!1),o.image(t,m.x,m.y,t.width*c,t.height*c),E.draw(o,c,m.x,m.y))},[c,o,t,m]);P.exports.useEffect(()=>{o&&t&&(o.draw=V,o.touchStarted=d=>{d.target.nodeName==="CANVAS"&&(g||E.touchStarted(o))},o.touchMoved=d=>{g?C({x:m.x+o.mouseX-o.pmouseX,y:m.y+o.mouseY-o.pmouseY}):E.touchMoved(o)},o.touchEnded=()=>{var d;g||(E.touchEnded(o),((d=E.enabledTool)==null?void 0:d.name)!==h.CropTool.toolName&&E.quitTool())},o.setup=()=>{const d={x:0,y:0};o.createCanvas(d.x,d.y),E.setup(o)},o.mouseWheel=d=>{if(d.target.nodeName==="CANVAS"){const y=c-d.deltaY/100;f(Math.max(Math.min(y,5),.5))}})},[o,t,V,g]),P.exports.useEffect(()=>{a.current&&new ft(d=>{n(d),d.preload=()=>{d.loadImage("https://picsum.photos/1200/600",y=>{e(y)}),E.preload(d)}},a.current)},[]);const it=d=>{M(void 0),(E==null?void 0:E.findTool(h.CropTool.toolName)).endCrop()},st=d=>{M(void 0),(E==null?void 0:E.findTool(h.CropTool.toolName)).doCrop(o)};return x("div",{className:"relative flex items-center justify-center w-screen h-screen overflow-hidden",id:"test",children:[u("div",{ref:a,className:"absolute left-0 right-0 top-0 bottom-0"}),u(yt,{manager:E,sk:o,onChangeDragging:()=>p(!g),dragging:g})]})}L.render(u(mt.StrictMode,{children:u(Mt,{})}),document.getElementById("root"));
//# sourceMappingURL=index.887c031d.js.map
