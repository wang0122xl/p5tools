var at=Object.defineProperty,lt=Object.defineProperties;var ct=Object.getOwnPropertyDescriptors;var Z=Object.getOwnPropertySymbols;var ht=Object.prototype.hasOwnProperty,ut=Object.prototype.propertyIsEnumerable;var B=(a,t,o)=>t in a?at(a,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):a[t]=o,S=(a,t)=>{for(var o in t||(t={}))ht.call(t,o)&&B(a,o,t[o]);if(Z)for(var o of Z(t))ut.call(t,o)&&B(a,o,t[o]);return a},M=(a,t)=>lt(a,ct(t));var r=(a,t,o)=>(B(a,typeof t!="symbol"?t+"":t,o),o);import{e as dt,_ as q,R as L,j as h,r as P,a as x,C as gt,F as Q,h as R,b as ft,P as mt,c as pt}from"./vendor.baa2301a.js";const At=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))n(e);new MutationObserver(e=>{for(const i of e)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function o(e){const i={};return e.integrity&&(i.integrity=e.integrity),e.referrerpolicy&&(i.referrerPolicy=e.referrerpolicy),e.crossorigin==="use-credentials"?i.credentials="include":e.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(e){if(e.ep)return;e.ep=!0;const i=o(e);fetch(e.href,i)}};At();function X(a,t){const o=Math.pow(t[0]-a[0],2)+Math.pow(t[1]-a[1],2);return Math.pow(o,1/2)}function Pt(a,t,o){const n=Math.atan2(a[1]-t[1],a[0]-t[0]);return o!=="DEGREES"?n:180/Math.PI*n}function xt(a,t,o){return new Promise(n=>{a.toBlob(e=>{n(e)},t,o)})}const _="EMITTER_PLUGIN_ACTIVED",z="EMITTER_ANNOTATION_INFO_UPDATED",H="EMITTER_ANNOTATION_INFO_UPDATED";var F=new dt.exports.EventEmitter;class N{constructor(t,o,n){r(this,"annotations",[]);r(this,"name");r(this,"editingAnnotation");r(this,"options");r(this,"pluginsCount",0);r(this,"pluginItemWH",20);r(this,"pluginItemMargin",5);r(this,"state");r(this,"scale",1);r(this,"translateX",0);r(this,"translateY",0);r(this,"loadedImage");r(this,"customConfigAnnotation");r(this,"getToolInfo",()=>Promise.resolve({time:new Date().getTime()}));r(this,"transformValue",t=>t*this.scale);r(this,"transformPoint",t=>[this.transformValue(t[0])+this.translateX,this.transformValue(t[1])+this.translateY]);r(this,"restorePoint",t=>[(t[0]-this.translateX)/this.scale,(t[1]-this.translateY)/this.scale]);this.name=t,o&&(this.annotations=o),this.state=n||{}}configAnnotation(t,o){var e;const n=o.options;if(n==null?void 0:n.strokeColor){const i=t.color(n.strokeColor),s=t.map(n.strokeAlpha||1,0,1,0,255);i.setAlpha(s),t.stroke(i)}else t.noStroke();(n==null?void 0:n.fillColor)?t.fill(n.fillColor):t.noFill(),(n==null?void 0:n.textSize)&&t.textSize(n.textSize*this.scale),(n==null?void 0:n.strokeWeight)&&t.strokeWeight(n.strokeWeight*this.scale),(n==null?void 0:n.textStyle)&&t.textStyle(n.textStyle),(e=this.customConfigAnnotation)==null||e.call(this,this,o)}getInitialOptions(){return{textSize:12,strokeColor:"#111",strokeWeight:1}}getInitialAnnotation(){const t=this;return{info:{time:new Date().getTime()},remove:function(){t.annotations.splice(t.annotations.indexOf(this),1)},belong:this.name,options:S(S({},this.getInitialOptions()),this.options),translateX:0,translateY:0,scale:1,transformedStartPoint:function(){if(!!this.startPoint)return[t.transformValue(this.startPoint[0]+this.translateX)+t.translateX,t.transformValue(this.startPoint[1]+this.translateY)+t.translateY]},transformedEndPoint:function(){if(!!this.endPoint)return[t.transformValue(this.endPoint[0]+this.translateX)+t.translateX,t.transformValue(this.endPoint[1]+this.translateY)+t.translateY]}}}validateAnnotation(t){return!(X(t.startPoint,t.endPoint)<2)}preload(t){}setup(t){}mouseMoved(t){}draw(t){}touchStarted(t){this.editingAnnotation=M(S({},this.getInitialAnnotation()),{startPoint:this.restorePoint([t.mouseX,t.mouseY])}),this.annotations.push(this.editingAnnotation)}touchMoved(t){this.editingAnnotation?this.editingAnnotation.endPoint=this.restorePoint([t.mouseX,t.mouseY]):this.touchStarted(t)}touchEnded(t){var o;!this.editingAnnotation||(this.editingAnnotation.endPoint=this.restorePoint([t.mouseX,t.mouseY]),this.validateAnnotation(this.editingAnnotation)?this.getToolInfo(this).then(n=>{this.editingAnnotation&&(this.editingAnnotation.info=n,F.emit(z))}).catch(n=>{console.warn(n)}).finally(()=>{this.editingAnnotation=void 0}):((o=this.annotations)==null||o.pop(),this.editingAnnotation=void 0))}reverseStartEndPointByOrder(){if(this.editingAnnotation&&this.editingAnnotation.startPoint&&this.editingAnnotation.endPoint){const[t,o]=this.editingAnnotation.startPoint,[n,e]=this.editingAnnotation.endPoint;this.editingAnnotation.startPoint=[Math.min(t,n),Math.min(o,e)],this.editingAnnotation.endPoint=[Math.max(t,n),Math.max(o,e)]}}pointInAnnotation(t,o){return!1}getPluginOrigin(t){return t.startPoint||[0,0]}pointInPluginLayer(t,o){const n=this.getPluginOrigin(o);return t[0]>n[0]&&t[0]<n[0]+(this.pluginItemWH+this.pluginItemMargin)*this.pluginsCount&&t[1]>n[1]&&t[1]<n[1]+this.pluginItemWH}}r(N,"toolName");class j extends N{constructor(t){super("CircleTool",t)}getPluginOrigin(t){const o=t.transformedStartPoint(),n=t.transformedEndPoint();if(o&&n){const e=X(o,n);return[o[0]+e+(t.options.strokeWeight||1)*this.scale/2,o[1]-this.pluginItemWH/2]}return[0,0]}pointInAnnotation(t,o){const n=o.transformedStartPoint(),e=o.transformedEndPoint();if(!n||!e)return!1;const i=X(n,e);return X(n,t)<i?!0:this.pointInPluginLayer(t,o)}touchEnded(t){if(super.touchEnded(t),this.editingAnnotation){const[o,n]=this.editingAnnotation.startPoint,e=X(this.editingAnnotation.startPoint,this.editingAnnotation.endPoint);this.editingAnnotation.endPoint=[o+e,n]}}draw(t){for(const o of this.annotations||[]){const n=o.transformedStartPoint(),e=o.transformedEndPoint();if(!n||!e)return;super.configAnnotation(t,o),t.circle(n[0],n[1],X(n,e)*2)}}}r(j,"toolName","CircleTool");class J extends N{constructor(t){super("SquareTool",t)}getPluginOrigin(t){const o=t.transformedStartPoint(),n=t.transformedEndPoint();if(!n||!o)return[0,0];const e=[o[0],n[0]],i=[o[1],n[1]];return[Math.max(...e)+(t.options.strokeWeight||1)*this.scale,Math.max(...i)-this.pluginItemWH+(t.options.strokeWeight||1)*this.scale/2]}touchEnded(t){super.touchEnded(t),this.reverseStartEndPointByOrder()}pointInAnnotation(t,o){const n=o.transformedStartPoint(),e=o.transformedEndPoint();if(!e||!n)return!1;const i=[n[0],e[0]],s=[n[1],e[1]];return t[0]<Math.max(...i)&&t[0]>Math.min(...i)&&t[1]<Math.max(...s)&&t[1]>Math.min(...s)?!0:this.pointInPluginLayer(t,o)}draw(t){for(const o of this.annotations||[]){const n=o.transformedStartPoint(),e=o.transformedEndPoint();if(!n||!e)return;super.configAnnotation(t,o),t.quad(n[0],n[1],e[0],n[1],e[0],e[1],n[0],e[1])}}}r(J,"toolName","SquareTool");class K extends N{constructor(t){super("LineTool",t);r(this,"showDistance",!1)}draw(t){var o,n;for(const e of this.annotations||[]){const i=e.transformedStartPoint(),s=e.transformedEndPoint();if(!i||!s)return;super.configAnnotation(t,e),t.line(i[0],i[1],s[0],s[1]),t.textSize(e.options.textSize*this.scale),t.fill(e.options.strokeColor),this.showDistance&&t.text(X(i,s).toFixed(1),(s[0]-i[0])/2+(((o=this.options)==null?void 0:o.strokeWeight)||5)+i[0],(s[1]-i[1])/2+(((n=this.options)==null?void 0:n.strokeWeight)||5)+i[1]+e.options.textSize)}}}r(K,"toolName","LineTool");class $ extends N{constructor(t){super("ArrowLineTool",t);this.getToolInfo=()=>{const o=prompt("\u8BF7\u8F93\u5165")||"";return Promise.resolve({title:o,time:new Date().getTime()})}}draw(t){var o;for(const n of this.annotations||[]){const e=n.transformedStartPoint(),i=n.transformedEndPoint();if(!e||!i)return;t.angleMode("degrees");const s=Pt(e,i,"DEGREES"),l=(((o=n.options)==null?void 0:o.strokeWeight)||1)*8,g=[e[0]+l*t.cos(s-145)*this.scale,e[1]+l*t.sin(s-145)*this.scale],f=[e[0]+l*t.cos(s+145)*this.scale,e[1]+l*t.sin(s+145)*this.scale];super.configAnnotation(t,n),t.line(e[0],e[1],i[0],i[1]),t.line(e[0],e[1],g[0],g[1]),t.line(e[0],e[1],f[0],f[1]),t.noStroke(),t.textSize(n.options.textSize*this.scale),t.fill(n.options.strokeColor),t.text(n.info.title||"",e[0]+5*t.cos(s)/4,e[1]+5*t.sin(s)/4+.8*(s>0?t.textAscent():-t.textAscent()*.5))}}}r($,"toolName","ArrowLineTool");class k extends N{constructor(t){super("FreehandTool",t)}getInitialAnnotation(){return M(S({},super.getInitialAnnotation()),{belong:"FreehandTool",freePaths:[]})}touchMoved(t){var e,i,s;const o=((e=this.editingAnnotation)==null?void 0:e.freePaths[this.editingAnnotation.freePaths.length-1])||((i=this.editingAnnotation)==null?void 0:i.startPoint),n=this.restorePoint([t.mouseX,t.mouseY]);o&&n&&X(o,n)>4&&((s=this.editingAnnotation)==null||s.freePaths.push(n))}draw(t){for(const o of this.annotations||[]){const n=o.startPoint,e=o.endPoint,i=[n,...o.freePaths,e];super.configAnnotation(t,o);for(let s=0;s<i.length-1;s++){const l=i[s],g=i[s+1];if(!g)break;const f=this.transformPoint(l),p=this.transformPoint(g);t.line(f[0],f[1],p[0],p[1])}}}}r(k,"toolName","FreehandTool");class tt extends N{constructor(t){super("TextTool",t);this.getToolInfo=()=>{const o=prompt("\u8BF7\u8F93\u5165")||"";return Promise.resolve({title:o,time:new Date().getTime()})}}validateAnnotation(t){return!0}touchEnded(t){super.touchEnded(t),this.editingAnnotation&&(this.editingAnnotation.startPoint=this.restorePoint([t.mouseX,t.mouseY]))}getPluginOrigin(t){const o=t.transformedStartPoint();return o?[o[0]-t.textWidth/2,o[1]-this.pluginItemWH-t.textHeight]:[0,0]}pointInAnnotation(t,o){const n=o.transformedStartPoint();if(!n)return!1;const e=o.textWidth/2;return t[0]>n[0]-e&&t[0]<n[0]+e&&t[1]>n[1]-o.textHeight&&t[1]<n[1]?!0:this.pointInPluginLayer(t,o)}draw(t){for(const o of this.annotations||[]){const n=o.transformedStartPoint();if(!n)return;super.configAnnotation(t,o),t.noStroke();const e=o.info.title||"",i=t.textWidth(e);o.textWidth=i;const s=t.textAscent();o.textHeight=s,t.text(e,n[0]-i/2,n[1])}}}r(tt,"toolName","TextTool");const Tt={top:"ns-resize","top-right":"nesw-resize","top-left":"nwse-resize",left:"ew-resize",right:"ew-resize","in-rect":"MOVE","out-rect":"default",bottom:"ns-resize","bottom-left":"nesw-resize","bottom-right":"nwse-resize"},A=6,G=(a,t,o)=>{let n="out-rect";if(!t||!o)return"out-rect";const[e,i]=a,s=Math.min(t[0],o[0]),l=Math.max(t[0],o[0]),g=Math.min(t[1],o[1]),f=Math.max(t[1],o[1]),p=e>s-A&&e<s+A,m=i>g-A&&i<g+A,C=e>l-A&&e<l+A,w=i>f-A&&i<f+A;return e>s+A&&e<l-A&&i>g+A&&i<f-A?n="in-rect":m?(n="top",p?n="top-left":C&&(n="top-right")):w?(n="bottom",p?n="bottom-left":C&&(n="bottom-right")):p?n="left":C?n="right":n="out-rect",n};class ot extends N{constructor(t,o){super("CropTool",t);r(this,"cursorPosition","out-rect");r(this,"touchStartPoint",[0,0]);r(this,"images",[]);r(this,"pg");r(this,"startRect");r(this,"endRect");this.state.cropedImages=o||[]}endCrop(){var t;(t=this.editingAnnotation)==null||delete t.startPoint,this.annotations=[]}async pureCrop(t,o,n,e){const[i,s]=o,[l,g]=n,f=t.get();t.noLoop(),t.clear(),t.image(f,0,0,t.width,t.height);const p=t.get(i+A/2,s+A/2,l-i-A,g-s-A).canvas,m=await xt(p,e);return t.loop(),m}async doCrop(t,o,n){const e=this.annotations[0];await(o==null?void 0:o(t));const i=await this.pureCrop(t,e.transformedStartPoint(),e.transformedEndPoint());if(await(n==null?void 0:n(t)),i){const s=URL.createObjectURL(i),l=await this.getToolInfo(this);this==null||this.images.push({info:l,url:s}),F.emit(H)}this.endCrop()}touchStarted(t){var i,s,l;const o=(i=this.editingAnnotation)==null?void 0:i.startPoint,n=(s=this.editingAnnotation)==null?void 0:s.endPoint,e=this.restorePoint([t.mouseX,t.mouseY]);this.cursorPosition=G(e,o,n),this.cursorPosition==="out-rect"&&(this.editingAnnotation=M(S({},this.getInitialAnnotation()),{belong:"CropTool",startPoint:e}),this.annotations=[this.editingAnnotation],(l=this.startRect)==null||l.call(this,{startX:e[0],startY:e[1]})),this.touchStartPoint=[t.mouseX,t.mouseY]}touchMoved(t){const o=this.editingAnnotation,n=this.restorePoint([t.mouseX,t.mouseY]);this.cursorPosition==="out-rect"&&(o.endPoint=n);const e=o.startPoint,i=o.endPoint;let s=e[0],l=e[1],g=i[0],f=i[1];const p=(t.mouseX-this.touchStartPoint[0])/this.scale,m=(t.mouseY-this.touchStartPoint[1])/this.scale;switch(this.cursorPosition){case"in-rect":s+=p,l+=m,g+=p,f+=m;break;case"top":l+=m;break;case"bottom":f+=m;break;case"left":s+=p;break;case"right":g+=p;break;case"top-left":s+=p,l+=m;break;case"top-right":g+=p,l+=m;break;case"bottom-left":s+=p,f+=m;break;case"bottom-right":g+=p,f+=m;break}o.startPoint=[s,l],o.endPoint=[g,f],this.touchStartPoint=[t.mouseX,t.mouseY],this.doEndRect()}doEndRect(){var n,e;if(!((n=this.editingAnnotation)==null?void 0:n.startPoint)||!this.editingAnnotation.endPoint)return;const t=this.editingAnnotation.transformedStartPoint(),o=this.editingAnnotation.transformedEndPoint();(e=this.endRect)==null||e.call(this,{startX:Math.min(t[0],o[0]),startY:Math.min(t[1],o[1]),endX:Math.max(t[0],o[0]),endY:Math.max(t[1],o[1])})}touchEnded(t){this.editingAnnotation&&this.reverseStartEndPointByOrder()}drawCropArea(t,o,n,e){if(!this.pg)return;const i=this.editingAnnotation;this.pg.erase(),this.pg.quad(t+i.translateX+1,o+i.translateY+1,n+i.translateX-1,o+i.translateY+1,n+i.translateX-1,e+i.translateY-1,t+i.translateX+1,e+i.translateY-1),this.pg.noErase()}draw(t){var m,C,w,Y,D;if(this.pg||(this.pg=t.createGraphics(t.width,t.height)),t.width!==this.pg.width||t.height!==this.pg.height?(this.pg.resizeCanvas(t.width,t.height),this.doEndRect()):(m=this.pg)==null||m.clear(),this.pg.background(0,0,0,120),!this.editingAnnotation)return;const o=this.editingAnnotation,n=o.transformedStartPoint(),e=o.transformedEndPoint();if(!n||!e)return;const i=Math.min(n[0],e[0]),s=Math.min(n[1],e[1]),l=Math.max(n[0],e[0]),g=Math.max(n[1],e[1]),f=G(this.restorePoint([t.mouseX,t.mouseY]),o.startPoint,o.endPoint);f==="out-rect"?t.cursor(t.CROSS):t.cursor(Tt[f]),this.pg.stroke(o.options.strokeColor),(C=this.pg)==null||C.stroke(o.options.strokeColor),(w=this.pg)==null||w.strokeWeight(1),this.pg.fill(255,255,255,255),(Y=this.pg)==null||Y.quad(i,s,l,s,l,g,i,g),this.drawCropArea(i,s,l,g);const p=[[i,s],[i,g],[l,s],[l,g]];(D=this.pg)==null||D.fill(o.options.strokeColor),p.forEach(([I,c])=>{var T;(T=this.pg)==null||T.quad(I-A/2,c-A/2,I+A/2,c-A/2,I+A/2,c+A/2,I-A/2,c+A/2)}),t.image(this.pg,0,0,t.width,t.height)}}r(ot,"toolName","CropTool");class nt extends N{constructor(){super("MagnifyTool");r(this,"areaWidth",50);r(this,"zoomScale",2)}draw(t){if(this.editingAnnotation&&this.loadedImage){const o=this.editingAnnotation.endPoint||this.editingAnnotation.startPoint,n=this.editingAnnotation.transformedEndPoint()||this.editingAnnotation.transformedStartPoint(),e=this.areaWidth/2,i=this.scale*this.zoomScale,s=this.areaWidth*i/2,l=this.loadedImage.get(o[0]-e,o[1]-e,this.areaWidth,this.areaWidth);t.image(l,n[0]-s,n[1]-s,this.areaWidth*i,this.areaWidth*i)}}}r(nt,"toolName","MagnifyTool");class U{constructor(t){r(this,"name","");r(this,"tools",[]);r(this,"enabled",!1);r(this,"active",!1);r(this,"iconUrl");r(this,"icon");r(this,"totalPluginsCount",0);r(this,"pluginIndex",0);r(this,"pluginItemWH",20);r(this,"pluginItemMargin",5);r(this,"touchStartPoint");r(this,"touchEndPoint",[0,0]);r(this,"editingAnnotation");r(this,"pluginLayerOrigin");r(this,"scale",1);r(this,"translateX",0);r(this,"translateY",0);this.iconUrl=t,F.on(_,o=>{o!==this.name&&(this.active=!1)})}preload(t){this.iconUrl&&t.loadImage(this.iconUrl,o=>{this.icon=o})}draw(t){if(!!this.enabled){for(const o of this.tools)for(const n of o.annotations)if(o.pointInAnnotation([t.mouseX,t.mouseY],n)){if(!n.startPoint)continue;this.pluginLayerOrigin=o.getPluginOrigin(n);const e=this.pluginLayerOrigin[0]+(this.pluginItemWH+this.pluginItemMargin)*this.pluginIndex;t.noStroke(),t.fill("#ffffff"),t.rect(e,this.pluginLayerOrigin[1],this.pluginItemWH,this.pluginItemWH),t.image(this.icon,e,this.pluginLayerOrigin[1],this.pluginItemWH,this.pluginItemWH)}}}touchStarted(t){for(const o of this.tools)for(const n of o.annotations){const e=o.getPluginOrigin(n),i=e[0]+(this.pluginItemWH+this.pluginItemMargin)*this.pluginIndex,s=e[1];if(t.mouseX>i&&t.mouseX<i+this.pluginItemWH&&t.mouseY>s&&t.mouseY<s+this.pluginItemWH){this.active=!0,this.editingAnnotation=n,o.getPluginOrigin(n),this.touchStartPoint=[t.mouseX,t.mouseY],F.emit(_,this.name);return}}}touchMoved(t){this.touchEndPoint=[t.mouseX,t.mouseY],this.handleTouchMoved(t)}touchEnded(t){this.active=!1}handleTouchMoved(t){}}r(U,"pluginName");const Ct="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAARVJREFUSEvFlsENwjAMRX/lbegE3JiiEzCApQ4ADFDJM3DsFJy4cYRhkCxQqga1IU0MKCKnHhw/2/8naQXjatt2papHAHci2nZdd7NsrSxBY/IeQD3GX4mosUCygEhyX5MJkgQEya/TDsbvLCQJYOY9gB2AIZGqOgiIqFZVP7KDiLi46MoBNgA2RNS7eTPzw2URkWrsrgFwEpHTV4Bw0xRgMYeLmXWQqyoFYOZZt76AFyAQNDrXDGCml7fwAAjdsuTxFGAphxfLOyJpu5wGMUjFzGcAa6toH8ZdygOs83eVfzWi4iL7mRa1aQBZPP4/HTSLO3IaxHL897Irfl0Xf3AiFp6OOfuavV3XS0IXffQDC3/82/IEL+oxZnXZjqwAAAAASUVORK5CYII=";class Et extends U{constructor(){super(Ct);this.name="MovePlugin"}handleTouchMoved(t){!this.editingAnnotation||(this.editingAnnotation.translateX=(this.touchEndPoint[0]-this.touchStartPoint[0])/this.scale+this.editingAnnotation.translateX,this.editingAnnotation.translateY=(this.touchEndPoint[1]-this.touchStartPoint[1])/this.scale+this.editingAnnotation.translateY,this.touchStartPoint=[t.mouseX,t.mouseY])}}const St="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAATtJREFUSEvllT1OxDAQhZ/jG3AMKLeiS0cD7VacIRklB2BzgESTgoaeZltoqNhuT7AcgQaJGzhBjmJkjEHZSahwl8gz3/y9scIfH+X8Z1m2SpLkKsbr+37ftu2TJJYBQEQpgOffHDDzZzDHgBxgA+AmMKzc9xIZhIA3rXVa1/XLMdHG7sYyeAdwAuCgtV7PhYSASmu9NcZsAZwtAfkGYOZNWZanS0GiAFvLAFJZsKQfA6Aoisuu6x6sDpqmeXSORsgawI6Zd2KAxHCqjUg8U53be/8YMO6v1OrGF+M4GAc3MOISEZFbL18UT0R2adrlOYy2GPCTGBcDRMQ4ZGKMuV0kg0CMbnf5EzyvRL4n19jwPZnVg3GK/EfKNtY/18x8L24yEfVTnlgxIM/zC6XUeQTyysx37r8YMHUffQC+w6kZYxwPvQAAAABJRU5ErkJggg==";class wt extends U{constructor(){super(St);this.name="ScalePlugin"}handleTouchMoved(t){if(!this.editingAnnotation)return;const[o,n]=this.editingAnnotation.endPoint,[e,i]=this.editingAnnotation.startPoint,s=o+(this.touchEndPoint[0]-this.touchStartPoint[0])/this.scale;let l=n+(this.touchEndPoint[1]-this.touchStartPoint[1])/this.scale;this.editingAnnotation.belong==="CircleTool"&&(l=i),this.editingAnnotation.startPoint=[Math.min(e,s),Math.min(i,l)],this.editingAnnotation.endPoint=[Math.max(e,s),Math.max(i,l)],this.touchStartPoint=[t.mouseX,t.mouseY]}}class et extends N{constructor(t){super("AngleTool",t)}angleTransformPoint(t,o){if(!!o)return[this.transformValue(o[0]+this.translateX)+t.translateX,this.transformValue(o[1]+this.translateY)+t.translateY]}touchStarted(t){this.editingAnnotation||(this.editingAnnotation=M(S({},this.getInitialAnnotation()),{belong:"AngleTool",points:[this.restorePoint([t.mouseX,t.mouseY])]}),this.annotations.push(this.editingAnnotation))}moved(t){!this.editingAnnotation||(this.editingAnnotation.points.length<3?this.editingAnnotation.points[1]=this.restorePoint([t.mouseX,t.mouseY]):this.editingAnnotation.points[2]=this.restorePoint([t.mouseX,t.mouseY]))}mouseMoved(t){this.moved(t)}touchMoved(t){this.moved(t)}touchEnded(t){!this.editingAnnotation||(this.editingAnnotation.points.length===2?this.editingAnnotation.points[2]=this.restorePoint([t.mouseX,t.mouseY]):this.editingAnnotation.points.length===3&&(this.editingAnnotation=void 0))}draw(t){for(const o of this.annotations){const[n,e,i]=o.points,[s,l,g]=[this.angleTransformPoint(o,n),this.angleTransformPoint(o,e),this.angleTransformPoint(o,i)];super.configAnnotation(t,o),s&&l&&t.line(s[0],s[1],l[0],l[1]),l&&g&&t.line(l[0],l[1],g[0],g[1])}}}r(et,"toolName","AngleTool");class u{constructor(){r(this,"tools",[]);r(this,"plugins",[]);r(this,"_toolsMapping",{});r(this,"touchStatus","end");r(this,"hasEnabledToolCallback");r(this,"_enabledTool");this.tools=[],this._toolsMapping={}}set enabledTool(t){var o;this._enabledTool=t,(o=this.hasEnabledToolCallback)==null||o.call(this,!!t);for(const n of this.plugins)n.enabled=!t}get enabledTool(){return this._enabledTool}useTool(t,o){return this.findTool(t.name)?(console.error("tool: %s\u5DF2\u5B58\u5728, \u8BF7\u52FF\u91CD\u590D\u6DFB\u52A0"),this):(this._toolsMapping[t.name]=t,t.getToolInfo=o||t.getToolInfo,this.tools.push(t),this)}removeTool(t){if(t&&this._toolsMapping[t.name]){delete this._toolsMapping[t.name];const o=q.indexOf(this.tools,t);this.tools.splice(o,1)}return this}usePlugin(t,o){let n=!1;for(const e of this.plugins)if(t.name===e.name){n=!0;break}n?console.error("%s\u5DF2\u5B58\u5728, \u8BF7\u52FF\u91CD\u590D\u6DFB\u52A0",t.name):(t.tools=o,this.plugins.push(t));for(let e=0;e<this.plugins.length;e++){const i=this.plugins[e];i.totalPluginsCount=this.plugins.length,i.pluginIndex=e}for(const e of this.tools)e.pluginsCount=this.plugins.length;return this}setup(t){for(const o of this.tools)o.setup(t)}preload(t){for(const o of this.tools)o.preload(t);for(const o of this.plugins)o.preload(t)}draw(t,o,n,e){for(const i of this.tools)i.scale=o||1,i.translateX=n||0,i.translateY=e||0,i.draw(t);for(const i of this.plugins)i.scale=o||1,i.translateX=n||0,i.translateY=e||0,i.draw(t)}mouseMoved(t){for(const o of this.tools)o.mouseMoved(t)}touchStarted(t){var o;this.touchStatus="start",(o=this.enabledTool)==null||o.touchStarted(t);for(const n of this.plugins)n.touchStarted(t)}touchMoved(t){var o;this.touchStatus="moving",(o=this.enabledTool)==null||o.touchMoved(t);for(const n of this.plugins)n.active&&n.touchMoved(t)}touchEnded(t){var o;this.touchStatus="end",(o=this.enabledTool)==null||o.touchEnded(t);for(const n of this.plugins)n.active&&n.touchEnded(t)}findTool(t){return this._toolsMapping[t]}setToolEnabled(t,o){const n=this.findTool(t);n?(n.options=o,this.enabledTool=n):console.error("\u672A\u8BBE\u7F6Etool\uFF1A%s",t)}quitTool(){this.enabledTool=void 0}getAllAnnotations(){let t=[];for(const o of this.tools)for(const n of o.annotations)t.push(n);return t}}r(u,"CircleTool",j),r(u,"SquareTool",J),r(u,"LineTool",K),r(u,"FreehandTool",k),r(u,"TextTool",tt),r(u,"ArrowLineTool",$),r(u,"AngleTool",et),r(u,"CropTool",ot),r(u,"MagnifyTool",nt),r(u,"MovePlugin",Et),r(u,"ScalePlugin",wt);const vt=a=>{const[t,o]=P.exports.useState("2"),[n,e]=P.exports.useState("1"),[i,s]=P.exports.useState("#f44336");return x("div",{className:"options",style:{top:a.rect.top,left:a.rect.left-290},children:[h("p",{children:"\u753B\u7B14\u7C97\u7EC6\uFF1A"}),h("input",{value:t,onChange:l=>o(l.target.value)}),h("p",{children:"\u900F\u660E\u5EA6\uFF1A"}),h("input",{value:n,onChange:l=>e(l.target.value)}),h("div",{children:h(gt,{color:i,onChange:l=>s(l.hex)})}),x("div",{className:"flex items-center mt-20px",children:[h("button",{className:"flex-1 mr-10px",onClick:()=>{a.onConfirm({width:parseFloat(t)||2,alpha:parseFloat(n)||1,color:i})},children:"\u786E\u8BA4"}),h("button",{className:"flex-1",onClick:a.onCancel,children:"\u53D6\u6D88"})]})]})},It=a=>{const t=a.target.getBoundingClientRect();return new Promise((o,n)=>{let e=document.createElement("div");e.style.position="fixed",e.style.left="0",e.style.right="0",e.style.bottom="0",e.style.top="0",document.body.appendChild(e);const i=()=>{L.unmountComponentAtNode(e),document.body.removeChild(e),e=null};L.render(h(vt,{rect:t,onCancel:()=>{i(),n()},onConfirm:s=>{i(),o(s)}}),e)})};const yt=a=>{const[t,o]=P.exports.useState(a.info);return x("div",{className:"w-250px bg-white flex flex-col p-20px children:my-5px",children:[h("p",{children:"\u6807\u9898: "}),h("input",{value:(t==null?void 0:t.title)||"",onChange:n=>o(M(S({},t),{title:n.target.value}))}),h("p",{children:"\u5907\u6CE8: "}),h("input",{value:(t==null?void 0:t.remark)||"",onChange:n=>o(M(S({},t),{remark:n.target.value}))}),h("p",{children:"\u5176\u4ED6\u4FE1\u606F: "}),h("input",{value:(t==null?void 0:t.others)||"",onChange:n=>o(M(S({},t),{others:n.target.value}))}),x("div",{className:"flex items-center mt-20px",children:[h("button",{className:"flex-1 mr-10px",onClick:()=>{a.onConfirm(M(S({},t),{time:new Date().getTime()}))},children:"\u786E\u8BA4"}),h("button",{className:"flex-1",onClick:a.onCancel,children:"\u53D6\u6D88"})]})]})},it=a=>new Promise(t=>{let o=document.createElement("div");o.style.position="fixed",o.style.left="0",o.style.right="0",o.style.bottom="0",o.style.top="0",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",document.body.appendChild(o);const n=()=>{L.unmountComponentAtNode(o),document.body.removeChild(o),o=null};L.render(h(yt,{info:a,onCancel:()=>{n(),t(!1)},onConfirm:e=>{n(),t(e)}}),o)}),Mt=a=>{const[t,o]=P.exports.useState(!0),[n,e]=P.exports.useState([]),[i,s]=P.exports.useState(!1),[l,g]=P.exports.useState([]),f=(c,T)=>{const b=R(c.info.time),v=R(T.info.time);return b.isAfter(v)?-1:1},p=()=>{const c=a.manager.getAllAnnotations().sort(f);e(c)},m=()=>{const T=a.manager.findTool(u.CropTool.toolName).images.sort(f);g([...T])};P.exports.useEffect(()=>(F.on(z,p),F.on(H,m),()=>{F.removeListener(z,p),F.removeListener(H,m)}),[]);const C=async(c,T)=>{var b;try{const v=await It(c);(b=a.sk)==null||b.cursor(a.sk.ARROW),T===u.TextTool.toolName?a.manager.setToolEnabled(T,{fillColor:v.color,strokeAlpha:v.alpha,textSize:v.width}):a.manager.setToolEnabled(T,{strokeColor:v.color,strokeAlpha:v.alpha,strokeWeight:v.width})}catch{a.manager.quitTool()}},w=()=>{var c;(c=a.sk)==null||c.cursor(a.sk.CROSS),a.manager.setToolEnabled(u.CropTool.toolName,{strokeColor:"blue"})},Y=async c=>{const T=await it(c.info);T&&(c.info=T,p())},D=c=>{c.remove(),p()},I=c=>{const T=a.manager.findTool(u.CropTool.toolName),b=T.images.indexOf(c);T.images.splice(b,1),m()};return x(Q,{children:[x("div",{className:"common-pannel pannel",children:[h("p",{onClick:c=>C(c,u.CircleTool.toolName),children:"\u5706\u5F62"}),h("p",{onClick:c=>C(c,u.SquareTool.toolName),children:"\u65B9\u5F62"}),h("p",{onClick:c=>C(c,u.TextTool.toolName),children:"\u6587\u5B57"}),h("p",{onClick:c=>C(c,u.LineTool.toolName),children:"\u76F4\u7EBF"}),h("p",{onClick:c=>C(c,u.ArrowLineTool.toolName),children:"\u7BAD\u5934"}),h("p",{onClick:c=>C(c,u.FreehandTool.toolName),children:"freehand"}),h("p",{onClick:c=>w(),children:"\u88C1\u526A"}),h("p",{onClick:c=>{t||s(!1),o(!t)},children:t?"\u9690\u85CF\u6807\u6CE8":"\u663E\u793A\u6807\u6CE8"}),h("p",{onClick:c=>{i||o(!1),s(!i)},children:i?"\u9690\u85CF\u622A\u56FE":"\u663E\u793A\u622A\u56FE"}),h("p",{onClick:c=>a.onChangeDragging(),children:a.dragging?"\u53D6\u6D88\u62D6\u52A8":"\u62D6\u52A8"})]}),t&&x("div",{className:"common-pannel annotations-layer",children:[h("div",{className:"title outer sticky top-0 bg-white",children:"\u6807\u6CE8\u4FE1\u606F"}),n.map(c=>c.belong===u.CropTool.toolName?null:x("div",{className:"items-center outer",children:[h("span",{className:"text-15px font-500",children:c.belong}),x("div",{className:"flex flex-col space-y-5px !py-5px flex-1 !mx-15px w-0",children:[x("span",{children:["\u6807\u9898: ",c.info.title]}),x("span",{children:["\u5907\u6CE8: ",c.info.remark]}),x("span",{children:["\u5176\u4ED6\u4FE1\u606F: ",c.info.others]}),x("span",{children:["\u65F6\u95F4: ",R(c.info.time).format("DD HH:mm:ss")]})]}),x("div",{className:"flex flex-col space-y-10px children:h-25px",children:[h("button",{onClick:()=>Y(c),children:"\u7F16\u8F91"}),h("button",{onClick:()=>D(c),children:"\u5220\u9664"})]})]},`annotation-${c.info.time}`))]}),i&&x("div",{className:"common-pannel images-layer",children:[h("div",{className:"title outer sticky top-0 bg-white",children:"\u622A\u56FE"}),l.map((c,T)=>x("div",{className:"flex flex-col space-y-5px outer",children:[x("span",{className:"font-500 text-15px",children:["\u6807\u9898: ",c.info.title]}),x("span",{children:["\u65F6\u95F4: ",R(c.info.time).format("YYYY-MM-DD HH:mm")]}),x("div",{className:"flex items-center !mx-0 !py-0",children:[h("img",{className:"flex-1 w-0 mr-10px",src:c.url}),h("button",{onClick:()=>I(c),children:"\u5220\u9664"})]})]},`image-${c.info.time}`))]})]})};function Nt(){const a=P.exports.useRef(null),[t,o]=P.exports.useState(),[n,e]=P.exports.useState(),[i,s]=P.exports.useState(),[l,g]=P.exports.useState(1),[f,p]=P.exports.useState(!1),[m,C]=P.exports.useState({x:0,y:0}),[w,Y]=P.exports.useState(),D=new u.TextTool,I=new u.CircleTool,c=new u.SquareTool,T=new u.LineTool,b=new u.FreehandTool,v=new u.ArrowLineTool,W=new u.CropTool;W.startRect=d=>{Y(void 0)},W.endRect=d=>{Y([d.startX,d.startY])};const O=async d=>{const y=await it();return y||q.last(d.annotations).remove(),M(S({},y),{time:new Date().getTime()})},[E]=P.exports.useState(()=>{const d=new u;return d.useTool(D,O).useTool(I,O).useTool(c,O).useTool(T,O).useTool(b,O).useTool(v,O).useTool(W,O),d.usePlugin(new u.MovePlugin,[I,c,D]).usePlugin(new u.ScalePlugin,[c,I]),d});P.exports.useEffect(()=>{if(n){const d=n.createDiv();d.addClass("w-130px h-50px"),ft.exports.render(x(Q,{children:[h("button",{className:"mr-10px w-50px h-30px",onClick:y=>{rt(y)},children:"\u786E\u8BA4"}),h("button",{className:"w-50px h-30px",onClick:st,children:"\u53D6\u6D88"})]}),d.elt),s(d)}},[n]),P.exports.useEffect(()=>{!i||(w?(i.position(w[0],w[1]-35),i.show()):i.hide())},[w,i]);const V=P.exports.useCallback(()=>{!n||!t||(n.clear(),n.resizeCanvas(t.width*l,t.height*l,!1),n.image(t,m.x,m.y,t.width*l,t.height*l),E.draw(n,l,m.x,m.y))},[l,n,t,m]);P.exports.useEffect(()=>{n&&t&&(n.draw=V,n.touchStarted=d=>{d.target.nodeName==="CANVAS"&&(f||E.touchStarted(n))},n.touchMoved=d=>{f?C({x:m.x+n.mouseX-n.pmouseX,y:m.y+n.mouseY-n.pmouseY}):E.touchMoved(n)},n.touchEnded=()=>{var d;f||(E.touchEnded(n),((d=E.enabledTool)==null?void 0:d.name)!==u.CropTool.toolName&&E.quitTool())},n.setup=()=>{const d={x:0,y:0};n.createCanvas(d.x,d.y),E.setup(n)},n.mouseWheel=d=>{if(d.target.nodeName==="CANVAS"){const y=l-d.deltaY/100;g(Math.max(Math.min(y,5),.5))}})},[n,t,V,f]),P.exports.useEffect(()=>{a.current&&new mt(d=>{e(d),d.preload=()=>{d.loadImage("https://picsum.photos/1200/600",y=>{o(y)}),E.preload(d)}},a.current)},[]);const st=d=>{Y(void 0),(E==null?void 0:E.findTool(u.CropTool.toolName)).endCrop()},rt=d=>{Y(void 0),(E==null?void 0:E.findTool(u.CropTool.toolName)).doCrop(n)};return x("div",{className:"relative flex items-center justify-center w-screen h-screen overflow-hidden",id:"test",children:[h("div",{ref:a,className:"absolute left-0 right-0 top-0 bottom-0"}),h(Mt,{manager:E,sk:n,onChangeDragging:()=>p(!f),dragging:f})]})}L.render(h(pt.StrictMode,{children:h(Nt,{})}),document.getElementById("root"));
//# sourceMappingURL=index.eb0d0011.js.map
