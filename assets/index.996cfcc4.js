var tt=Object.defineProperty,ot=Object.defineProperties;var et=Object.getOwnPropertyDescriptors;var H=Object.getOwnPropertySymbols;var nt=Object.prototype.hasOwnProperty,it=Object.prototype.propertyIsEnumerable;var L=(r,t,e)=>t in r?tt(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,w=(r,t)=>{for(var e in t||(t={}))nt.call(t,e)&&L(r,e,t[e]);if(H)for(var e of H(t))it.call(t,e)&&L(r,e,t[e]);return r},b=(r,t)=>ot(r,et(t));var s=(r,t,e)=>(L(r,typeof t!="symbol"?t+"":t,e),e);import{e as st,R as O,j as u,r as C,a as T,C as rt,F as U,h as D,b as at,P as lt,c as ct}from"./vendor.30843403.js";const ut=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function e(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerpolicy&&(i.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?i.credentials="include":n.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(n){if(n.ep)return;n.ep=!0;const i=e(n);fetch(n.href,i)}};ut();function F(r,t){const e=Math.pow(t[0]-r[0],2)+Math.pow(t[1]-r[1],2);return Math.pow(e,1/2)}function ht(r,t,e){const o=Math.atan2(r[1]-t[1],r[0]-t[0]);return e!=="DEGREES"?o:180/Math.PI*o}const z="EMITTER_PLUGIN_ACTIVED",R="EMITTER_ANNOTATION_INFO_UPDATED",B="EMITTER_ANNOTATION_INFO_UPDATED";var y=new st.exports.EventEmitter;class M{constructor(t,e,o){s(this,"annotations",[]);s(this,"name");s(this,"editingAnnotation");s(this,"options");s(this,"pluginsCount",0);s(this,"pluginItemWH",20);s(this,"pluginItemMargin",5);s(this,"state");s(this,"scale",1);s(this,"translateX",0);s(this,"translateY",0);s(this,"getToolInfo");s(this,"transformValue",(t,e)=>t*this.scale+(e||0));s(this,"transformPoint",t=>[this.transformValue(t[0]+this.translateX),this.transformValue(t[1]+this.translateY)]);s(this,"restorePoint",t=>[t[0]/this.scale-this.translateX,t[1]/this.scale-this.translateY]);this.name=t,e&&(this.annotations=e),this.state=o||{}}configAnnotation(t,e){const o=e.options;if(o==null?void 0:o.strokeColor){const n=t.color(o.strokeColor),i=t.map(o.strokeAlpha||1,0,1,0,255);n.setAlpha(i),t.stroke(n)}else t.noStroke();(o==null?void 0:o.fillColor)?t.fill(o.fillColor):t.noFill(),(o==null?void 0:o.textSize)&&t.textSize(o.textSize*this.scale),(o==null?void 0:o.strokeWeight)&&t.strokeWeight(o.strokeWeight*this.scale),(o==null?void 0:o.textStyle)&&t.textStyle(o.textStyle)}getInitialOptions(){return{textSize:12,strokeColor:"#111",strokeWeight:1}}getInitialAnnotation(){const t=this;return{info:{time:new Date().getTime()},belong:this.name,options:w(w({},this.getInitialOptions()),this.options),translateX:0,translateY:0,scale:1,transformedStartPoint:function(){if(!!this.startPoint)return[t.transformValue(this.startPoint[0]+this.translateX),t.transformValue(this.startPoint[1]+this.translateY)]},transformedEndPoint:function(){if(!!this.endPoint)return[t.transformValue(this.endPoint[0]+this.translateX),t.transformValue(this.endPoint[1]+this.translateY)]}}}validateAnnotation(t){return!(F(t.startPoint,t.endPoint)<2)}preload(t){}setup(t){}mouseMoved(t){}draw(t){}touchStarted(t,e){this.editingAnnotation=b(w({},this.getInitialAnnotation()),{startPoint:this.restorePoint([t.mouseX,t.mouseY])}),this.annotations.push(this.editingAnnotation)}touchMoved(t){this.editingAnnotation.endPoint=this.restorePoint([t.mouseX,t.mouseY])}touchEnded(t){var e,o;this.editingAnnotation.endPoint=this.restorePoint([t.mouseX,t.mouseY]),this.validateAnnotation(this.editingAnnotation)?(o=this.getToolInfo)==null||o.call(this,this).then(n=>{this.editingAnnotation&&(this.editingAnnotation.info=n,y.emit(R))}).catch(n=>{console.warn(n)}):((e=this.annotations)==null||e.pop(),this.editingAnnotation=void 0)}reverseStartEndPointByOrder(){if(this.editingAnnotation&&this.editingAnnotation.startPoint&&this.editingAnnotation.endPoint){const[t,e]=this.editingAnnotation.startPoint,[o,n]=this.editingAnnotation.endPoint;this.editingAnnotation.startPoint=[Math.min(t,o),Math.min(e,n)],this.editingAnnotation.endPoint=[Math.max(t,o),Math.max(e,n)]}}pointInAnnotation(t,e){return!1}getPluginOrigin(t){return t.startPoint||[0,0]}pointInPluginLayer(t,e){const o=this.getPluginOrigin(e);return t[0]>o[0]&&t[0]<o[0]+(this.pluginItemWH+this.pluginItemMargin)*this.pluginsCount&&t[1]>o[1]&&t[1]<o[1]+this.pluginItemWH}}s(M,"toolName");class V extends M{constructor(t){super("CircleTool",t)}getPluginOrigin(t){const e=t.transformedStartPoint(),o=t.transformedEndPoint();if(e&&o){const n=F(e,o);return[e[0]+n+(t.options.strokeWeight||1)*this.scale/2,e[1]-this.pluginItemWH/2]}return[0,0]}pointInAnnotation(t,e){const o=e.transformedStartPoint(),n=e.transformedEndPoint();if(!o||!n)return!1;const i=F(o,n);return F(o,t)<i?!0:this.pointInPluginLayer(t,e)}touchEnded(t){if(super.touchEnded(t),this.editingAnnotation){const[e,o]=this.editingAnnotation.startPoint,n=F(this.editingAnnotation.startPoint,this.editingAnnotation.endPoint);this.editingAnnotation.endPoint=[e+n,o]}}draw(t){for(const e of this.annotations||[]){const o=e.transformedStartPoint(),n=e.transformedEndPoint();if(!o||!n)return;super.configAnnotation(t,e),t.circle(o[0],o[1],F(o,n)*2)}}}s(V,"toolName","CircleTool");class Z extends M{constructor(t){super("SquareTool",t)}getPluginOrigin(t){const e=t.transformedStartPoint(),o=t.transformedEndPoint();if(!o||!e)return[0,0];const n=[e[0],o[0]],i=[e[1],o[1]];return[Math.max(...n)+(t.options.strokeWeight||1)*this.scale,Math.max(...i)-this.pluginItemWH+(t.options.strokeWeight||1)*this.scale/2]}touchEnded(t){super.touchEnded(t),this.reverseStartEndPointByOrder()}pointInAnnotation(t,e){const o=e.transformedStartPoint(),n=e.transformedEndPoint();if(!n||!o)return!1;const i=[o[0],n[0]],a=[o[1],n[1]];return t[0]<Math.max(...i)&&t[0]>Math.min(...i)&&t[1]<Math.max(...a)&&t[1]>Math.min(...a)?!0:this.pointInPluginLayer(t,e)}draw(t){for(const e of this.annotations||[]){const o=e.transformedStartPoint(),n=e.transformedEndPoint();if(!o||!n)return;super.configAnnotation(t,e),t.quad(o[0],o[1],n[0],o[1],n[0],n[1],o[0],n[1])}}}s(Z,"toolName","SquareTool");class _ extends M{constructor(t){super("LineTool",t)}draw(t){for(const e of this.annotations||[]){const o=e.transformedStartPoint(),n=e.transformedEndPoint();if(!o||!n)return;super.configAnnotation(t,e),t.line(o[0],o[1],n[0],n[1])}}}s(_,"toolName","LineTool");class q extends M{async defaultGetToolInfo(){return{title:prompt("\u8BF7\u8F93\u5165")||"",time:new Date().getTime()}}constructor(t){super("ArrowLineTool",t)}draw(t){var e;for(const o of this.annotations||[]){const n=o.transformedStartPoint(),i=o.transformedEndPoint();if(!n||!i)return;t.angleMode("degrees");const a=ht(n,i,"DEGREES"),c=(((e=o.options)==null?void 0:e.strokeWeight)||1)*8,f=[n[0]+c*t.cos(a-145)*this.scale,n[1]+c*t.sin(a-145)*this.scale],m=[n[0]+c*t.cos(a+145)*this.scale,n[1]+c*t.sin(a+145)*this.scale];super.configAnnotation(t,o),t.line(n[0],n[1],i[0],i[1]),t.line(n[0],n[1],f[0],f[1]),t.line(n[0],n[1],m[0],m[1]),t.noStroke(),t.textSize(o.options.textSize*this.scale),t.fill(o.options.strokeColor),t.text(o.info.title||"",n[0]+5*t.cos(a)/4,n[1]+5*t.sin(a)/4+.8*(a>0?t.textAscent():-t.textAscent()*.5))}}}s(q,"toolName","ArrowLineTool");class Q extends M{constructor(t){super("FreehandTool",t)}getInitialAnnotation(){return b(w({},super.getInitialAnnotation()),{belong:"FreehandTool",freePaths:[]})}touchMoved(t){var n,i,a;const e=((n=this.editingAnnotation)==null?void 0:n.freePaths[this.editingAnnotation.freePaths.length-1])||((i=this.editingAnnotation)==null?void 0:i.startPoint),o=this.restorePoint([t.mouseX,t.mouseY]);e&&o&&F(e,o)>4&&((a=this.editingAnnotation)==null||a.freePaths.push(o))}draw(t){for(const e of this.annotations||[]){const o=e.startPoint,n=e.endPoint,i=[o,...e.freePaths,n];super.configAnnotation(t,e);for(let a=0;a<i.length-1;a++){const c=i[a],f=i[a+1];if(!f)break;const m=this.transformPoint(c),g=this.transformPoint(f);t.line(m[0],m[1],g[0],g[1])}}}}s(Q,"toolName","FreehandTool");class j extends M{async defaultGetToolInfo(){return{title:prompt("\u8BF7\u8F93\u5165")||"",time:new Date().getTime()}}constructor(t){super("TextTool",t)}validateAnnotation(t){return!0}touchEnded(t){super.touchEnded(t),this.editingAnnotation&&(this.editingAnnotation.startPoint=this.restorePoint([t.mouseX,t.mouseY]))}getPluginOrigin(t){const e=t.transformedStartPoint();return e?[e[0]-t.textWidth/2,e[1]-this.pluginItemWH-t.textHeight]:[0,0]}pointInAnnotation(t,e){const o=e.transformedStartPoint();if(!o)return!1;const n=e.textWidth/2;return t[0]>o[0]-n&&t[0]<o[0]+n&&t[1]>o[1]-e.textHeight&&t[1]<o[1]?!0:this.pointInPluginLayer(t,e)}draw(t){for(const e of this.annotations||[]){const o=e.transformedStartPoint();if(!o)return;super.configAnnotation(t,e),t.noStroke();const n=e.info.title||"",i=t.textWidth(n);e.textWidth=i;const a=t.textAscent();e.textHeight=a,t.text(n,o[0]-i/2,o[1])}}}s(j,"toolName","TextTool");const dt={top:"ns-resize","top-right":"nesw-resize","top-left":"nwse-resize",left:"ew-resize",right:"ew-resize","in-rect":"MOVE","out-rect":"default",bottom:"ns-resize","bottom-left":"nesw-resize","bottom-right":"nwse-resize"},p=6,G=(r,t,e)=>{let o="out-rect";if(!t||!e)return"out-rect";const[n,i]=r,a=Math.min(t[0],e[0]),c=Math.max(t[0],e[0]),f=Math.min(t[1],e[1]),m=Math.max(t[1],e[1]),g=n>a-p&&n<a+p,A=i>f-p&&i<f+p,E=n>c-p&&n<c+p,v=i>m-p&&i<m+p;return n>a+p&&n<c-p&&i>f+p&&i<m-p?o="in-rect":A?(o="top",g?o="top-left":E&&(o="top-right")):v?(o="bottom",g?o="bottom-left":E&&(o="bottom-right")):g?o="left":E?o="right":o="out-rect",o};class J extends M{constructor(t,e){super("CropTool",t);s(this,"cursorPosition","out-rect");s(this,"touchStartPoint",[0,0]);s(this,"images",[]);s(this,"pg");s(this,"startRect");s(this,"endRect");s(this,"initialGetInfo",()=>Promise.resolve({}));this.state.cropedImages=e||[]}endCrop(){var t;(t=this.editingAnnotation)==null||delete t.startPoint,this.annotations=[]}async doCrop(t,e,o){const n=this.annotations[0],[i,a]=n.transformedStartPoint(),[c,f]=n.transformedEndPoint();t.get(i+p/2,a+p/2,c-i-p,f-a-p).canvas.toBlob(g=>{if(g){const A=URL.createObjectURL(g);(this.getToolInfo||this.initialGetInfo)(this).then(E=>{this==null||this.images.push({info:E,url:A}),y.emit(B)})}}),this.endCrop()}touchStarted(t,e){var a,c,f;if(e.target.nodeName!=="CANVAS")return;const o=(a=this.editingAnnotation)==null?void 0:a.startPoint,n=(c=this.editingAnnotation)==null?void 0:c.endPoint,i=this.restorePoint([t.mouseX,t.mouseY]);this.cursorPosition=G(i,o,n),this.cursorPosition==="out-rect"&&(this.editingAnnotation=b(w({},this.getInitialAnnotation()),{belong:"CropTool",startPoint:i}),this.annotations=[this.editingAnnotation],(f=this.startRect)==null||f.call(this,{startX:i[0],startY:i[1]})),this.touchStartPoint=[t.mouseX,t.mouseY]}touchMoved(t){const e=this.editingAnnotation,o=this.restorePoint([t.mouseX,t.mouseY]);this.cursorPosition==="out-rect"&&(e.endPoint=o);const n=e.startPoint,i=e.endPoint;let a=n[0],c=n[1],f=i[0],m=i[1];const g=(t.mouseX-this.touchStartPoint[0])/this.scale,A=(t.mouseY-this.touchStartPoint[1])/this.scale;switch(this.cursorPosition){case"in-rect":a+=g,c+=A,f+=g,m+=A;break;case"top":c+=A;break;case"bottom":m+=A;break;case"left":a+=g;break;case"right":f+=g;break;case"top-left":a+=g,c+=A;break;case"top-right":f+=g,c+=A;break;case"bottom-left":a+=g,m+=A;break;case"bottom-right":f+=g,m+=A;break}e.startPoint=[a,c],e.endPoint=[f,m],this.touchStartPoint=[t.mouseX,t.mouseY],this.doEndRect()}doEndRect(){var o,n;if(!((o=this.editingAnnotation)==null?void 0:o.startPoint)||!this.editingAnnotation.endPoint)return;const t=this.editingAnnotation.transformedStartPoint(),e=this.editingAnnotation.transformedEndPoint();(n=this.endRect)==null||n.call(this,{startX:Math.min(t[0],e[0]),startY:Math.min(t[1],e[1]),endX:Math.max(t[0],e[0]),endY:Math.max(t[1],e[1])})}touchEnded(t){this.editingAnnotation&&this.reverseStartEndPointByOrder()}drawCropArea(t,e,o,n){if(!this.pg)return;const i=this.editingAnnotation;this.pg.erase(),this.pg.quad(t+i.translateX+1,e+i.translateY+1,o+i.translateX-1,e+i.translateY+1,o+i.translateX-1,n+i.translateY-1,t+i.translateX+1,n+i.translateY-1),this.pg.noErase()}draw(t){var A,E,v,Y,X;if(this.pg||(this.pg=t.createGraphics(t.width,t.height)),t.width!==this.pg.width||t.height!==this.pg.height?(this.pg.resizeCanvas(t.width,t.height),this.doEndRect()):(A=this.pg)==null||A.clear(),this.pg.background(0,0,0,120),!this.editingAnnotation)return;const e=this.editingAnnotation,o=e.transformedStartPoint(),n=e.transformedEndPoint();if(!o||!n)return;const i=Math.min(o[0],n[0]),a=Math.min(o[1],n[1]),c=Math.max(o[0],n[0]),f=Math.max(o[1],n[1]),m=G(this.restorePoint([t.mouseX,t.mouseY]),e.startPoint,e.endPoint);m==="out-rect"?t.cursor(t.CROSS):t.cursor(dt[m]),this.pg.stroke(e.options.strokeColor),(E=this.pg)==null||E.stroke(e.options.strokeColor),(v=this.pg)==null||v.strokeWeight(1),this.pg.fill(255,255,255,255),(Y=this.pg)==null||Y.quad(i,a,c,a,c,f,i,f),this.drawCropArea(i,a,c,f);const g=[[i,a],[i,f],[c,a],[c,f]];(X=this.pg)==null||X.fill(e.options.strokeColor),g.forEach(([N,l])=>{var P;(P=this.pg)==null||P.quad(N-p/2,l-p/2,N+p/2,l-p/2,N+p/2,l+p/2,N-p/2,l+p/2)}),t.image(this.pg,0,0,t.width,t.height)}}s(J,"toolName","CropTool");class W{constructor(t){s(this,"name","");s(this,"tools",[]);s(this,"enabled",!1);s(this,"active",!1);s(this,"iconUrl");s(this,"icon");s(this,"totalPluginsCount",0);s(this,"pluginIndex",0);s(this,"pluginItemWH",20);s(this,"pluginItemMargin",5);s(this,"touchStartPoint");s(this,"touchEndPoint",[0,0]);s(this,"editingAnnotation");s(this,"pluginLayerOrigin");s(this,"scale",1);s(this,"translateX",0);s(this,"translateY",0);this.iconUrl=t,y.on(z,e=>{e!==this.name&&(this.active=!1)})}preload(t){t.loadImage(this.iconUrl,e=>{this.icon=e})}draw(t){if(!!this.enabled){for(const e of this.tools)for(const o of e.annotations)if(e.pointInAnnotation([t.mouseX,t.mouseY],o)){if(!o.startPoint)continue;this.pluginLayerOrigin=e.getPluginOrigin(o);const n=this.pluginLayerOrigin[0]+(this.pluginItemWH+this.pluginItemMargin)*this.pluginIndex;t.noStroke(),t.fill("#ffffff"),t.rect(n,this.pluginLayerOrigin[1],this.pluginItemWH,this.pluginItemWH),t.image(this.icon,n,this.pluginLayerOrigin[1],this.pluginItemWH,this.pluginItemWH)}}}touchStarted(t){for(const e of this.tools)for(const o of e.annotations){const n=e.getPluginOrigin(o),i=n[0]+(this.pluginItemWH+this.pluginItemMargin)*this.pluginIndex,a=n[1];if(t.mouseX>i&&t.mouseX<i+this.pluginItemWH&&t.mouseY>a&&t.mouseY<a+this.pluginItemWH){this.active=!0,this.editingAnnotation=o,e.getPluginOrigin(o),this.touchStartPoint=[t.mouseX,t.mouseY],y.emit(z,this.name);return}}}touchMoved(t){this.touchEndPoint=[t.mouseX,t.mouseY],this.handleTouchMoved(t)}touchEnded(t){this.active=!1}handleTouchMoved(t){}}s(W,"pluginName");var ft="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAARVJREFUSEvFlsENwjAMRX/lbegE3JiiEzCApQ4ADFDJM3DsFJy4cYRhkCxQqga1IU0MKCKnHhw/2/8naQXjatt2papHAHci2nZdd7NsrSxBY/IeQD3GX4mosUCygEhyX5MJkgQEya/TDsbvLCQJYOY9gB2AIZGqOgiIqFZVP7KDiLi46MoBNgA2RNS7eTPzw2URkWrsrgFwEpHTV4Bw0xRgMYeLmXWQqyoFYOZZt76AFyAQNDrXDGCml7fwAAjdsuTxFGAphxfLOyJpu5wGMUjFzGcAa6toH8ZdygOs83eVfzWi4iL7mRa1aQBZPP4/HTSLO3IaxHL897Irfl0Xf3AiFp6OOfuavV3XS0IXffQDC3/82/IEL+oxZnXZjqwAAAAASUVORK5CYII=";class gt extends W{constructor(){super(ft);this.name="MovePlugin"}handleTouchMoved(t){!this.editingAnnotation||(this.editingAnnotation.translateX=(this.touchEndPoint[0]-this.touchStartPoint[0])/this.scale+this.editingAnnotation.translateX,this.editingAnnotation.translateY=(this.touchEndPoint[1]-this.touchStartPoint[1])/this.scale+this.editingAnnotation.translateY,this.touchStartPoint=[t.mouseX,t.mouseY])}}var mt="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAATtJREFUSEvllT1OxDAQhZ/jG3AMKLeiS0cD7VacIRklB2BzgESTgoaeZltoqNhuT7AcgQaJGzhBjmJkjEHZSahwl8gz3/y9scIfH+X8Z1m2SpLkKsbr+37ftu2TJJYBQEQpgOffHDDzZzDHgBxgA+AmMKzc9xIZhIA3rXVa1/XLMdHG7sYyeAdwAuCgtV7PhYSASmu9NcZsAZwtAfkGYOZNWZanS0GiAFvLAFJZsKQfA6Aoisuu6x6sDpqmeXSORsgawI6Zd2KAxHCqjUg8U53be/8YMO6v1OrGF+M4GAc3MOISEZFbL18UT0R2adrlOYy2GPCTGBcDRMQ4ZGKMuV0kg0CMbnf5EzyvRL4n19jwPZnVg3GK/EfKNtY/18x8L24yEfVTnlgxIM/zC6XUeQTyysx37r8YMHUffQC+w6kZYxwPvQAAAABJRU5ErkJggg==";class pt extends W{constructor(){super(mt);this.name="ScalePlugin"}handleTouchMoved(t){if(!this.editingAnnotation)return;const[e,o]=this.editingAnnotation.endPoint,[n,i]=this.editingAnnotation.startPoint,a=e+(this.touchEndPoint[0]-this.touchStartPoint[0])/this.scale;let c=o+(this.touchEndPoint[1]-this.touchStartPoint[1])/this.scale;this.editingAnnotation.belong==="CircleTool"&&(c=i),this.editingAnnotation.startPoint=[Math.min(n,a),Math.min(i,c)],this.editingAnnotation.endPoint=[Math.max(n,a),Math.max(i,c)],this.touchStartPoint=[t.mouseX,t.mouseY]}}class h{constructor(t){s(this,"tools",[]);s(this,"plugins",[]);s(this,"_toolsMapping",{});s(this,"touchStatus","end");s(this,"hasEnabledToolCallback");s(this,"_enabledTool");s(this,"_getToolInfo");this.tools=[],this._toolsMapping={},this._getToolInfo=t}set enabledTool(t){var e;this._enabledTool=t,(e=this.hasEnabledToolCallback)==null||e.call(this,!!t);for(const o of this.plugins)o.enabled=!t}get enabledTool(){return this._enabledTool}useTool(t){return this.findTool(t.name)?(console.error("tool: %s\u5DF2\u5B58\u5728, \u8BF7\u52FF\u91CD\u590D\u6DFB\u52A0"),this):(this._toolsMapping[t.name]=t,t.getToolInfo=t.getToolInfo||this._getToolInfo,this.tools.push(t),this)}usePlugin(t,e){let o=!1;for(const n of this.plugins)if(t.name===n.name){o=!0;break}o?console.error("%s\u5DF2\u5B58\u5728, \u8BF7\u52FF\u91CD\u590D\u6DFB\u52A0",t.name):(t.tools=e,this.plugins.push(t));for(let n=0;n<this.plugins.length;n++){const i=this.plugins[n];i.totalPluginsCount=this.plugins.length,i.pluginIndex=n}for(const n of this.tools)n.pluginsCount=this.plugins.length;return this}setup(t){for(const e of this.tools)e.setup(t)}preload(t){for(const e of this.tools)e.preload(t);for(const e of this.plugins)e.preload(t)}draw(t,e,o,n){for(const i of this.tools)i.scale=e||1,i.translateX=o||0,i.translateY=n||0,i.draw(t);for(const i of this.plugins)i.scale=e||1,i.translateX=o||0,i.translateY=n||0,i.draw(t)}mouseMoved(t){}touchStarted(t,e){var o;this.touchStatus="start",(o=this.enabledTool)==null||o.touchStarted(t,e);for(const n of this.plugins)n.touchStarted(t)}touchMoved(t){var e;this.touchStatus="moving",(e=this.enabledTool)==null||e.touchMoved(t);for(const o of this.plugins)o.active&&o.touchMoved(t)}touchEnded(t){var e;this.touchStatus="end",(e=this.enabledTool)==null||e.touchEnded(t);for(const o of this.plugins)o.active&&o.touchEnded(t)}findTool(t){return this._toolsMapping[t]}setToolEnabled(t,e){const o=this.findTool(t);o?(o.options=e,this.enabledTool=o):console.error("\u672A\u8BBE\u7F6Etool\uFF1A%s",t)}quitTool(){this.enabledTool=void 0}getAllAnnotations(){let t=[];for(const e of this.tools)for(const o of e.annotations)t.push(o);return t}}s(h,"CircleTool",V),s(h,"SquareTool",Z),s(h,"LineTool",_),s(h,"FreehandTool",Q),s(h,"TextTool",j),s(h,"ArrowLineTool",q),s(h,"CropTool",J),s(h,"MovePlugin",gt),s(h,"ScalePlugin",pt);const At=r=>{const[t,e]=C.exports.useState("2"),[o,n]=C.exports.useState("1"),[i,a]=C.exports.useState("#f44336");return T("div",{className:"options",style:{top:r.rect.top,left:r.rect.left-290},children:[u("p",{children:"\u753B\u7B14\u7C97\u7EC6\uFF1A"}),u("input",{value:t,onChange:c=>e(c.target.value)}),u("p",{children:"\u900F\u660E\u5EA6\uFF1A"}),u("input",{value:o,onChange:c=>n(c.target.value)}),u("div",{children:u(rt,{color:i,onChange:c=>a(c.hex)})}),T("div",{className:"flex items-center mt-20px",children:[u("button",{className:"flex-1 mr-10px",onClick:()=>{r.onConfirm({width:parseFloat(t)||2,alpha:parseFloat(o)||1,color:i})},children:"\u786E\u8BA4"}),u("button",{className:"flex-1",onClick:r.onCancel,children:"\u53D6\u6D88"})]})]})},Pt=r=>{const t=r.target.getBoundingClientRect();return new Promise((e,o)=>{let n=document.createElement("div");n.style.position="fixed",n.style.left="0",n.style.right="0",n.style.bottom="0",n.style.top="0",document.body.appendChild(n);const i=()=>{O.unmountComponentAtNode(n),document.body.removeChild(n),n=null};O.render(u(At,{rect:t,onCancel:()=>{i(),o()},onConfirm:a=>{i(),e(a)}}),n)})};const xt=r=>{const[t,e]=C.exports.useState(r.info);return T("div",{className:"w-250px bg-white flex flex-col p-20px children:my-5px",children:[u("p",{children:"\u6807\u9898: "}),u("input",{value:(t==null?void 0:t.title)||"",onChange:o=>e(b(w({},t),{title:o.target.value}))}),u("p",{children:"\u5907\u6CE8: "}),u("input",{value:(t==null?void 0:t.remark)||"",onChange:o=>e(b(w({},t),{remark:o.target.value}))}),u("p",{children:"\u5176\u4ED6\u4FE1\u606F: "}),u("input",{value:(t==null?void 0:t.others)||"",onChange:o=>e(b(w({},t),{others:o.target.value}))}),T("div",{className:"flex items-center mt-20px",children:[u("button",{className:"flex-1 mr-10px",onClick:()=>{r.onConfirm(b(w({},t),{time:new Date().getTime()}))},children:"\u786E\u8BA4"}),u("button",{className:"flex-1",onClick:r.onCancel,children:"\u53D6\u6D88"})]})]})},K=r=>new Promise(t=>{let e=document.createElement("div");e.style.position="fixed",e.style.left="0",e.style.right="0",e.style.bottom="0",e.style.top="0",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",document.body.appendChild(e);const o=()=>{O.unmountComponentAtNode(e),document.body.removeChild(e),e=null};O.render(u(xt,{info:r,onCancel:()=>{o(),t(!1)},onConfirm:n=>{o(),t(n)}}),e)}),Tt=r=>{const[t,e]=C.exports.useState(!0),[o,n]=C.exports.useState([]),[i,a]=C.exports.useState(!1),[c,f]=C.exports.useState([]),m=(l,P)=>{const x=D(l.info.time),S=D(P.info.time);return x.isAfter(S)?-1:1},g=()=>{const l=r.manager.getAllAnnotations().sort(m);n(l)},A=()=>{const P=r.manager.findTool(h.CropTool.toolName).images.sort(m);f([...P])};C.exports.useEffect(()=>(y.on(R,g),y.on(B,A),()=>{y.removeListener(R,g),y.removeListener(B,A)}),[]);const E=async(l,P)=>{var x;try{const S=await Pt(l);(x=r.sk)==null||x.cursor(r.sk.ARROW),P===h.TextTool.toolName?r.manager.setToolEnabled(P,{fillColor:S.color,strokeAlpha:S.alpha,textSize:S.width}):r.manager.setToolEnabled(P,{strokeColor:S.color,strokeAlpha:S.alpha,strokeWeight:S.width})}catch{r.manager.quitTool()}},v=()=>{var l;(l=r.sk)==null||l.cursor(r.sk.CROSS),r.manager.setToolEnabled(h.CropTool.name,{strokeColor:"blue"})},Y=async l=>{const P=await K(l.info);P&&(l.info=P,g())},X=l=>{const P=r.manager.findTool(l.belong);P.annotations.splice(P.annotations.indexOf(l),1),g()},N=l=>{const P=r.manager.findTool(h.CropTool.toolName),x=P.images.indexOf(l);P.images.splice(x,1),A()};return T(U,{children:[T("div",{className:"common-pannel pannel",children:[u("p",{onClick:l=>E(l,h.CircleTool.toolName),children:"\u5706\u5F62"}),u("p",{onClick:l=>E(l,h.SquareTool.toolName),children:"\u65B9\u5F62"}),u("p",{onClick:l=>E(l,h.TextTool.toolName),children:"\u6587\u5B57"}),u("p",{onClick:l=>E(l,h.LineTool.toolName),children:"\u76F4\u7EBF"}),u("p",{onClick:l=>E(l,h.ArrowLineTool.toolName),children:"\u7BAD\u5934"}),u("p",{onClick:l=>E(l,h.FreehandTool.toolName),children:"freehand"}),u("p",{onClick:l=>v(),children:"\u88C1\u526A"}),u("p",{onClick:l=>{t||a(!1),e(!t)},children:t?"\u9690\u85CF\u6807\u6CE8":"\u663E\u793A\u6807\u6CE8"}),u("p",{onClick:l=>{i||e(!1),a(!i)},children:i?"\u9690\u85CF\u622A\u56FE":"\u663E\u793A\u622A\u56FE"})]}),t&&T("div",{className:"common-pannel annotations-layer",children:[u("div",{className:"title outer sticky top-0 bg-white",children:"\u6807\u6CE8\u4FE1\u606F"}),o.map(l=>l.belong===h.CropTool.toolName?null:T("div",{className:"items-center outer",children:[u("span",{className:"text-15px font-500",children:l.belong}),T("div",{className:"flex flex-col space-y-5px !py-5px flex-1 !mx-15px w-0",children:[T("span",{children:["\u6807\u9898: ",l.info.title]}),T("span",{children:["\u5907\u6CE8: ",l.info.remark]}),T("span",{children:["\u5176\u4ED6\u4FE1\u606F: ",l.info.others]}),T("span",{children:["\u65F6\u95F4: ",D(l.info.time).format("DD HH:mm:ss")]})]}),T("div",{className:"flex flex-col space-y-10px children:h-25px",children:[u("button",{onClick:()=>Y(l),children:"\u7F16\u8F91"}),u("button",{onClick:()=>X(l),children:"\u5220\u9664"})]})]},`annotation-${l.info.time}`))]}),i&&T("div",{className:"common-pannel images-layer",children:[u("div",{className:"title outer sticky top-0 bg-white",children:"\u622A\u56FE"}),c.map((l,P)=>T("div",{className:"flex flex-col space-y-5px outer",children:[T("span",{className:"font-500 text-15px",children:["\u6807\u9898: ",l.info.title]}),T("span",{children:["\u65F6\u95F4: ",D(l.info.time).format("YYYY-MM-DD HH:mm")]}),T("div",{className:"flex items-center !mx-0 !py-0",children:[u("img",{className:"flex-1 w-0 mr-10px",src:l.url}),u("button",{onClick:()=>N(l),children:"\u5220\u9664"})]})]},`image-${l.info.time}`))]})]})};function Ct(){const r=C.exports.useRef(null),[t,e]=C.exports.useState(),[o,n]=C.exports.useState(),[i,a]=C.exports.useState(),[c,f]=C.exports.useState(1),[m,g]=C.exports.useState(),A=new h.TextTool,E=new h.CircleTool,v=new h.SquareTool,Y=new h.LineTool,X=new h.FreehandTool,N=new h.ArrowLineTool,l=new h.CropTool;l.startRect=d=>{g(void 0)},l.endRect=d=>{g([d.startX,d.startY])};const P=async d=>{const I=await K();return b(w({},I),{time:new Date().getTime()})},[x]=C.exports.useState(()=>{const d=new h(P);return d.useTool(A).useTool(E).useTool(v).useTool(Y).useTool(X).useTool(N).useTool(l),d.usePlugin(new h.MovePlugin,[E,v,A]).usePlugin(new h.ScalePlugin,[v,E]),d});C.exports.useEffect(()=>{if(o){const d=o.createDiv();d.addClass("w-130px h-50px"),at.exports.render(T(U,{children:[u("button",{className:"mr-10px w-50px h-30px",onClick:I=>{$(I)},children:"\u786E\u8BA4"}),u("button",{className:"w-50px h-30px",onClick:k,children:"\u53D6\u6D88"})]}),d.elt),a(d)}},[o]),C.exports.useEffect(()=>{!i||(m?(i.position(m[0],m[1]-35),i.show()):i.hide())},[m,i]);const S=C.exports.useCallback(()=>{!o||!t||(o.clear(),o.resizeCanvas(t.width*c,t.height*c,!1),o.image(t,0,0,t.width*c,t.height*c),x.draw(o,c))},[c,o,t]);C.exports.useEffect(()=>{o&&t&&(o.draw=S,o.touchStarted=d=>{d.target.nodeName==="CANVAS"&&x.touchStarted(o,d)},o.touchMoved=d=>{x.touchMoved(o)},o.touchEnded=()=>{var d;x.touchEnded(o),((d=x.enabledTool)==null?void 0:d.name)!==h.CropTool.toolName&&x.quitTool()},o.setup=()=>{const d={x:0,y:0};o.createCanvas(d.x,d.y),x.setup(o)},o.mouseWheel=d=>{if(d.target.nodeName==="CANVAS"){const I=c-d.deltaY/100;f(Math.max(Math.min(I,5),.5))}})},[o,t,S]),C.exports.useEffect(()=>{r.current&&new lt(d=>{n(d),d.preload=()=>{d.loadImage("https://picsum.photos/1200/600",I=>{console.log(I),e(I)}),x.preload(d)}},r.current)},[]);const k=d=>{g(void 0),(x==null?void 0:x.findTool(h.CropTool.toolName)).endCrop()},$=d=>{g(void 0),(x==null?void 0:x.findTool(h.CropTool.toolName)).doCrop(o)};return T("div",{className:"relative flex items-center justify-center w-screen h-screen overflow-hidden",id:"test",children:[u("div",{ref:r,className:"absolute left-0 right-0 top-0 bottom-0"}),u(Tt,{manager:x,sk:o})]})}O.render(u(ct.StrictMode,{children:u(Ct,{})}),document.getElementById("root"));
//# sourceMappingURL=index.996cfcc4.js.map
